<?php
// ============================================================================
// ENTERTAINMENT TADKA BOT - COMPLETE MERGED VERSION WITH AUTO-NOTIFICATION
// ============================================================================

// ==============================
// SECURITY HEADERS & BASIC SETUP
// ==============================
header("X-Content-Type-Options: nosniff");
header("X-Frame-Options: DENY");
header("X-XSS-Protection: 1; mode=block");
header("Referrer-Policy: strict-origin-when-cross-origin");

// ==============================
// RENDER.COM SPECIFIC CONFIGURATION  
// ==============================
$port = getenv('PORT') ?: '80';
$webhook_url = getenv('RENDER_EXTERNAL_URL') ?: 'https://your-bot-name.onrender.com';

if (!getenv('BOT_TOKEN')) {
    die("âŒ BOT_TOKEN environment variable set nahi hai. Render.com dashboard mein set karo.");
}

// ==============================
// ENVIRONMENT VARIABLES CONFIGURATION
// ==============================
define('BOT_TOKEN', getenv('BOT_TOKEN'));
define('CHANNEL_ID', getenv('CHANNEL_ID', '-1003251791991'));
define('BACKUP_CHANNEL_ID', getenv('BACKUP_CHANNEL_ID', '-1002964109368'));
define('BACKUP_CHANNEL_USERNAME', getenv('BACKUP_CHANNEL_USERNAME', '@ETBackup'));
define('ADMIN_ID', (int)getenv('ADMIN_ID', '1080317415'));

// NEW: AUTO-NOTIFICATION CONFIGURATION
define('REQUEST_GROUP_ID', getenv('REQUEST_GROUP_ID', '-1001234567890'));  // REQUEST GROUP ID
define('REQUEST_CHANNEL', getenv('REQUEST_CHANNEL', '@EntertainmentTadka7860'));
define('MAIN_CHANNEL', getenv('MAIN_CHANNEL', '@EntertainmentTadka786'));
define('THEATER_PRINT_CHANNEL', getenv('THEATER_PRINT_CHANNEL', '@threater_print_movies'));

// File paths
define('CSV_FILE', 'movies.csv');
define('USERS_FILE', 'users.json');
define('STATS_FILE', 'bot_stats.json');
define('REQUEST_FILE', 'movie_requests.json');
define('BACKUP_DIR', 'backups/');
define('LOG_FILE', 'bot_activity.log');

// ==============================
// ENHANCED PAGINATION CONSTANTS
// ==============================
define('ITEMS_PER_PAGE', 5);                    // Har page par kitne movies
define('MAX_PAGES_TO_SHOW', 7);                 // Max page buttons to display
define('PAGINATION_CACHE_TIMEOUT', 60);         // Cache timeout in seconds
define('PREVIEW_ITEMS', 3);                     // Preview mein kitne items
define('BATCH_SIZE', 5);                        // Batch download size
define('VIDEO_PREVIEW_ENABLED', true);          // Video preview feature
define('MAX_VIDEO_PREVIEWS', 3);                // Max video previews per page
define('CACHE_EXPIRY', 300);                    // 5 minutes cache
define('MAX_SEARCH_RESULTS', 15);               // Maximum search results
define('DAILY_REQUEST_LIMIT', 5);               // Daily movie request limit per user
define('AUTO_BACKUP_HOUR', '03');               // Auto backup time (3 AM)

// ==============================
// MAINTENANCE MODE
// ==============================
$MAINTENANCE_MODE = false;
$MAINTENANCE_MESSAGE = "ğŸ› ï¸ <b>Bot Under Maintenance</b>\n\nWe're temporarily unavailable for updates.\nWill be back in few days!\n\nThanks for patience ğŸ™";

// ==============================
// GLOBAL VARIABLES
// ==============================
$movie_messages = array();
$movie_cache = array();
$waiting_users = array();
$user_sessions = array();
$user_pagination_sessions = array();  // Pagination sessions storage

// ==============================
// STEP 1: FILE INITIALIZATION FUNCTION
// ==============================
function initialize_files() {
    $files = [
        CSV_FILE => "movie_name,message_id,date,video_path,quality,size,language\n",
        USERS_FILE => json_encode([
            'users' => [],
            'total_requests' => 0,
            'message_logs' => [],
            'daily_stats' => []
        ], JSON_PRETTY_PRINT),
        STATS_FILE => json_encode([
            'total_movies' => 0,
            'total_users' => 0,
            'total_searches' => 0,
            'total_downloads' => 0,
            'successful_searches' => 0,
            'failed_searches' => 0,
            'daily_activity' => [],
            'last_updated' => date('Y-m-d H:i:s')
        ], JSON_PRETTY_PRINT),
        REQUEST_FILE => json_encode([
            'requests' => [],
            'pending_approval' => [],
            'completed_requests' => [],
            'user_request_count' => []
        ], JSON_PRETTY_PRINT)
    ];
    
    foreach ($files as $file => $content) {
        if (!file_exists($file)) {
            file_put_contents($file, $content);
            @chmod($file, 0666);
        }
    }
    
    if (!file_exists(BACKUP_DIR)) {
        @mkdir(BACKUP_DIR, 0777, true);
    }
    
    if (!file_exists(LOG_FILE)) {
        file_put_contents(LOG_FILE, "[" . date('Y-m-d H:i:s') . "] SYSTEM: Files initialized\n");
    }
}

// Initialize all files
initialize_files();

// ==============================
// STEP 2: LOGGING SYSTEM
// ==============================
function bot_log($message, $type = 'INFO') {
    $timestamp = date('Y-m-d H:i:s');
    $log_entry = "[$timestamp] $type: $message\n";
    file_put_contents(LOG_FILE, $log_entry, FILE_APPEND);
}

// ==============================
// STEP 3: TELEGRAM API FUNCTIONS
// ==============================
function apiRequest($method, $params = array(), $is_multipart = false) {
    $url = "https://api.telegram.org/bot" . BOT_TOKEN . "/" . $method;
    
    if ($is_multipart) {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $params);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        $res = curl_exec($ch);
        if ($res === false) {
            bot_log("CURL ERROR: " . curl_error($ch), 'ERROR');
        }
        curl_close($ch);
        return $res;
    } else {
        $options = array(
            'http' => array(
                'method' => 'POST',
                'content' => http_build_query($params),
                'header' => "Content-Type: application/x-www-form-urlencoded\r\n"
            )
        );
        $context = stream_context_create($options);
        $result = @file_get_contents($url, false, $context);
        if ($result === false) {
            bot_log("API Request failed for method: $method", 'ERROR');
        }
        return $result;
    }
}

function sendMessage($chat_id, $text, $reply_markup = null, $parse_mode = null) {
    $data = [
        'chat_id' => $chat_id,
        'text' => $text,
        'disable_web_page_preview' => true
    ];
    if ($reply_markup) $data['reply_markup'] = json_encode($reply_markup);
    if ($parse_mode) $data['parse_mode'] = $parse_mode;
    
    $result = apiRequest('sendMessage', $data);
    bot_log("Message sent to $chat_id: " . substr($text, 0, 50) . "...");
    return json_decode($result, true);
}

function editMessage($chat_id, $message_id, $new_text, $reply_markup = null) {
    $data = [
        'chat_id' => $chat_id,
        'message_id' => $message_id,
        'text' => $new_text,
        'disable_web_page_preview' => true
    ];
    if ($reply_markup) $data['reply_markup'] = json_encode($reply_markup);
    apiRequest('editMessageText', $data);
}

function deleteMessage($chat_id, $message_id) {
    apiRequest('deleteMessage', [
        'chat_id' => $chat_id,
        'message_id' => $message_id
    ]);
}

function answerCallbackQuery($callback_query_id, $text = null, $show_alert = false) {
    $data = [
        'callback_query_id' => $callback_query_id,
        'show_alert' => $show_alert
    ];
    if ($text) $data['text'] = $text;
    apiRequest('answerCallbackQuery', $data);
}

function forwardMessage($chat_id, $from_chat_id, $message_id) {
    $result = apiRequest('forwardMessage', [
        'chat_id' => $chat_id,
        'from_chat_id' => $from_chat_id,
        'message_id' => $message_id
    ]);
    return $result;
}

function copyMessage($chat_id, $from_chat_id, $message_id) {
    return apiRequest('copyMessage', [
        'chat_id' => $chat_id,
        'from_chat_id' => $from_chat_id,
        'message_id' => $message_id
    ]);
}

// ==============================
// STEP 4: AUTO-NOTIFICATION FUNCTION (NEW)
// ==============================
function send_upload_notification($movie_name, $quality, $language, $message_id) {
    /*
    Jab bhi koi movie channel pe upload hogi,
    yeh function REQUEST GROUP mein notification bhejega
    EXACT tumhare diye hue format mein
    */
    
    $message = "ğŸ¬ <b>NEW UPLOAD ALERT!</b>\n\n";
    $message .= "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    
    $message .= "âœ… <b>Movie / Webseries Add Ho Gayi Hai:</b> \n\n";
    $message .= "â€¢ <b>Name:</b> $movie_name\n\n";
    
    $message .= "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    
    $message .= "ğŸ“¥ <b>Abhi Available Hai:</b> â€¢ Bot se search karo: <code>$movie_name</code>\n\n";
    
    $message .= "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    
    $message .= "ğŸ¯ <b>Bot Use Karne Ka Tarika:</b> \n";
    $message .= "â€¢ Search ke liye: <code>/search $movie_name</code>\n\n";
    $message .= "â€¢ Sab uploads dekhne ke liye: <code>/totalupload</code> (Sirf Admin Ke liye)\n\n";
    
    $message .= "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    
    $message .= "ğŸ“¢ <b>Join Our Channels:</b>\n\n";
    $message .= "ğŸ¿ Main: " . MAIN_CHANNEL . "\n  \n";
    $message .= "ğŸ“¥ Requests: " . REQUEST_CHANNEL . "\n\n";
    $message .= "ğŸ­ Theater Print Channel: " . THEATER_PRINT_CHANNEL . "\n\n";
    $message .= "ğŸ”’ Backup: " . BACKUP_CHANNEL_USERNAME . "\n\n";
    
    $message .= "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    
    $message .= "ğŸ”” <b>Aur movies/webseries ke liye request karte raho!</b> ğŸ”¥";
    
    try {
        // REQUEST GROUP mein message send karo
        $result = sendMessage(REQUEST_GROUP_ID, $message, null, 'HTML');
        
        if ($result && isset($result['ok']) && $result['ok']) {
            bot_log("Upload notification sent to REQUEST GROUP for: $movie_name");
            
            // Log the notification
            $notifications_file = 'upload_notifications.json';
            $notifications = [];
            
            if (file_exists($notifications_file)) {
                $notifications = json_decode(file_get_contents($notifications_file), true);
            }
            
            $notification_id = uniqid();
            $notifications[$notification_id] = [
                'movie_name' => $movie_name,
                'message_id' => $message_id,
                'sent_to' => REQUEST_GROUP_ID,
                'sent_time' => date('Y-m-d H:i:s'),
                'status' => 'sent'
            ];
            
            file_put_contents($notifications_file, json_encode($notifications, JSON_PRETTY_PRINT));
            
            return true;
        }
    } catch (Exception $e) {
        bot_log("Failed to send upload notification: " . $e->getMessage(), 'ERROR');
    }
    
    return false;
}

// ==============================
// STEP 5: UPDATED MOVIE DELIVERY SYSTEM - COPY PRIORITY
// ==============================
function deliver_item_to_chat($chat_id, $item) {
    // Pehle copyMessage try karo (source visible nahi hoga)
    if (!empty($item['message_id']) && is_numeric($item['message_id'])) {
        $result = json_decode(copyMessage($chat_id, CHANNEL_ID, $item['message_id']), true);
        
        if ($result && $result['ok']) {
            update_stats('total_downloads', 1);
            bot_log("Movie COPIED from CHANNEL: {$item['movie_name']} to $chat_id");
            return true;
        } else {
            // Copy fail hua toh forward try karo
            forwardMessage($chat_id, CHANNEL_ID, $item['message_id']);
            update_stats('total_downloads', 1);
            bot_log("Movie forwarded from CHANNEL: {$item['movie_name']} to $chat_id");
            return true;
        }
    }

    // Minimal text format (no source mention)
    $text = "ğŸ¬ <b>" . ($item['movie_name'] ?? 'Unknown') . "</b>\n";
    $text .= "ğŸ“Š Quality: " . ($item['quality'] ?? 'Unknown') . "\n";
    $text .= "ğŸ’¾ Size: " . ($item['size'] ?? 'Unknown') . "\n";
    $text .= "ğŸ—£ï¸ Language: " . ($item['language'] ?? 'Hindi') . "\n";
    
    sendMessage($chat_id, $text, null, 'HTML');
    return false;
}

// ==============================
// STEP 6: STATISTICS SYSTEM
// ==============================
function update_stats($field, $increment = 1) {
    if (!file_exists(STATS_FILE)) return;
    
    $stats = json_decode(file_get_contents(STATS_FILE), true);
    $stats[$field] = ($stats[$field] ?? 0) + $increment;
    $stats['last_updated'] = date('Y-m-d H:i:s');
    
    $today = date('Y-m-d');
    if (!isset($stats['daily_activity'][$today])) {
        $stats['daily_activity'][$today] = [
            'searches' => 0,
            'downloads' => 0,
            'users' => 0
        ];
    }
    
    if ($field == 'total_searches') $stats['daily_activity'][$today]['searches'] += $increment;
    if ($field == 'total_downloads') $stats['daily_activity'][$today]['downloads'] += $increment;
    
    file_put_contents(STATS_FILE, json_encode($stats, JSON_PRETTY_PRINT));
}

function get_stats() {
    if (!file_exists(STATS_FILE)) return [];
    return json_decode(file_get_contents(STATS_FILE), true);
}

// ==============================
// STEP 7: USER MANAGEMENT
// ==============================
function update_user_data($user_id, $user_info = []) {
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    
    if (!isset($users_data['users'][$user_id])) {
        $users_data['users'][$user_id] = [
            'first_name' => $user_info['first_name'] ?? '',
            'last_name' => $user_info['last_name'] ?? '',
            'username' => $user_info['username'] ?? '',
            'joined' => date('Y-m-d H:i:s'),
            'last_active' => date('Y-m-d H:i:s'),
            'points' => 0,
            'total_searches' => 0,
            'total_downloads' => 0,
            'request_count' => 0,
            'last_request_date' => null
        ];
        $users_data['total_requests'] = ($users_data['total_requests'] ?? 0) + 1;
        update_stats('total_users', 1);
        bot_log("New user registered: $user_id");
    }
    
    $users_data['users'][$user_id]['last_active'] = date('Y-m-d H:i:s');
    file_put_contents(USERS_FILE, json_encode($users_data, JSON_PRETTY_PRINT));
    
    return $users_data['users'][$user_id];
}

function update_user_activity($user_id, $action) {
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    
    if (isset($users_data['users'][$user_id])) {
        $points_map = [
            'search' => 1,
            'found_movie' => 5,
            'daily_login' => 10,
            'movie_request' => 2,
            'download' => 3
        ];
        
        $users_data['users'][$user_id]['points'] += ($points_map[$action] ?? 0);
        
        if ($action == 'search') $users_data['users'][$user_id]['total_searches']++;
        if ($action == 'download') $users_data['users'][$user_id]['total_downloads']++;
        
        $users_data['users'][$user_id]['last_active'] = date('Y-m-d H:i:s');
        file_put_contents(USERS_FILE, json_encode($users_data, JSON_PRETTY_PRINT));
    }
}

// ==============================
// STEP 8: CACHING SYSTEM
// ==============================
function get_cached_movies() {
    global $movie_cache;
    
    if (!empty($movie_cache) && (time() - $movie_cache['timestamp']) < CACHE_EXPIRY) {
        return $movie_cache['data'];
    }
    
    $movie_cache = [
        'data' => load_and_clean_csv(),
        'timestamp' => time()
    ];
    
    bot_log("Movie cache refreshed - " . count($movie_cache['data']) . " movies");
    return $movie_cache['data'];
}

// ==============================
// STEP 9: CSV MANAGEMENT FUNCTIONS
// ==============================
function load_and_clean_csv($filename = CSV_FILE) {
    global $movie_messages;
    
    if (!file_exists($filename)) {
        file_put_contents($filename, "movie_name,message_id,date,video_path,quality,size,language\n");
        return [];
    }

    $data = [];
    $handle = fopen($filename, "r");
    if ($handle !== FALSE) {
        $header = fgetcsv($handle);
        
        while (($row = fgetcsv($handle)) !== FALSE) {
            if (count($row) >= 3 && (!empty(trim($row[0])))) {
                $movie_name = trim($row[0]);
                $message_id_raw = isset($row[1]) ? trim($row[1]) : '';
                $date = isset($row[2]) ? trim($row[2]) : '';
                $video_path = isset($row[3]) ? trim($row[3]) : '';
                $quality = isset($row[4]) ? trim($row[4]) : 'Unknown';
                $size = isset($row[5]) ? trim($row[5]) : 'Unknown';
                $language = isset($row[6]) ? trim($row[6]) : 'Hindi';

                $entry = [
                    'movie_name' => $movie_name,
                    'message_id_raw' => $message_id_raw,
                    'date' => $date,
                    'video_path' => $video_path,
                    'quality' => $quality,
                    'size' => $size,
                    'language' => $language,
                    'message_id' => is_numeric($message_id_raw) ? intval($message_id_raw) : null
                ];
                
                $data[] = $entry;
                $movie = strtolower($movie_name);
                if (!isset($movie_messages[$movie])) $movie_messages[$movie] = [];
                $movie_messages[$movie][] = $entry;
            }
        }
        fclose($handle);
    }

    $stats = json_decode(file_get_contents(STATS_FILE), true);
    $stats['total_movies'] = count($data);
    $stats['last_updated'] = date('Y-m-d H:i:s');
    file_put_contents(STATS_FILE, json_encode($stats, JSON_PRETTY_PRINT));

    $handle = fopen($filename, "w");
    fputcsv($handle, array('movie_name','message_id','date','video_path','quality','size','language'));
    foreach ($data as $row) {
        fputcsv($handle, [
            $row['movie_name'], 
            $row['message_id_raw'], 
            $row['date'], 
            $row['video_path'],
            $row['quality'],
            $row['size'],
            $row['language']
        ]);
    }
    fclose($handle);

    bot_log("CSV cleaned and reloaded - " . count($data) . " entries");
    return $data;
}

// ==============================
// STEP 10: UPDATED MOVIE APPEND FUNCTION WITH AUTO-NOTIFICATION
// ==============================
function append_movie($movie_name, $message_id_raw, $date = null, $video_path = '', $quality = 'Unknown', $size = 'Unknown', $language = 'Hindi') {
    if (empty(trim($movie_name))) return;
    
    if ($date === null) $date = date('d-m-Y');
    $entry = [$movie_name, $message_id_raw, $date, $video_path, $quality, $size, $language];
    
    $handle = fopen(CSV_FILE, "a");
    fputcsv($handle, $entry);
    fclose($handle);

    global $movie_messages, $movie_cache, $waiting_users;
    $movie = strtolower(trim($movie_name));
    $item = [
        'movie_name' => $movie_name,
        'message_id_raw' => $message_id_raw,
        'date' => $date,
        'video_path' => $video_path,
        'quality' => $quality,
        'size' => $size,
        'language' => $language,
        'message_id' => is_numeric($message_id_raw) ? intval($message_id_raw) : null
    ];
    
    if (!isset($movie_messages[$movie])) $movie_messages[$movie] = [];
    $movie_messages[$movie][] = $item;
    $movie_cache = [];

    // âœ… NEW: AUTO-NOTIFICATION TO REQUEST GROUP
    send_upload_notification($movie_name, $quality, $language, $message_id_raw);

    // Waiting users ko notify karo
    foreach ($waiting_users as $query => $users) {
        if (strpos($movie, $query) !== false) {
            foreach ($users as $user_data) {
                list($user_chat_id, $user_id) = $user_data;
                deliver_item_to_chat($user_chat_id, $item);
                sendMessage($user_chat_id, "âœ… '$query' ab channel me add ho gaya!");
            }
            unset($waiting_users[$query]);
        }
    }

    update_stats('total_movies', 1);
    bot_log("Movie appended with notification: $movie_name with ID $message_id_raw");
}

// ==============================
// STEP 11: SEARCH SYSTEM
// ==============================
function smart_search($query) {
    global $movie_messages;
    $query_lower = strtolower(trim($query));
    $results = array();
    
    foreach ($movie_messages as $movie => $entries) {
        $score = 0;
        
        if ($movie == $query_lower) {
            $score = 100;
        }
        elseif (strpos($movie, $query_lower) !== false) {
            $score = 80 - (strlen($movie) - strlen($query_lower));
        }
        else {
            similar_text($movie, $query_lower, $similarity);
            if ($similarity > 60) $score = $similarity;
        }
        
        foreach ($entries as $entry) {
            if (stripos($entry['quality'] ?? '', '1080') !== false) $score += 5;
            if (stripos($entry['quality'] ?? '', '720') !== false) $score += 3;
            if (stripos($entry['language'] ?? '', 'hindi') !== false) $score += 2;
        }
        
        if ($score > 0) {
            $results[$movie] = [
                'score' => $score,
                'count' => count($entries),
                'latest_entry' => end($entries),
                'qualities' => array_unique(array_column($entries, 'quality'))
            ];
        }
    }
    
    uasort($results, function($a, $b) {
        return $b['score'] - $a['score'];
    });
    
    return array_slice($results, 0, MAX_SEARCH_RESULTS);
}

function detect_language($text) {
    $hindi_keywords = ['à¤«à¤¿à¤²à¥à¤®', 'à¤®à¥‚à¤µà¥€', 'à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡', 'à¤¹à¤¿à¤‚à¤¦à¥€', 'à¤šà¤¾à¤¹à¤¿à¤', 'à¤•à¤¹à¤¾à¤', 'à¤•à¥ˆà¤¸à¥‡', 'à¤–à¥‹à¤œ', 'à¤¤à¤²à¤¾à¤¶'];
    $english_keywords = ['movie', 'download', 'watch', 'print', 'search', 'find', 'looking', 'want', 'need'];
    
    $hindi_score = 0;
    $english_score = 0;
    
    foreach ($hindi_keywords as $k) {
        if (strpos($text, $k) !== false) $hindi_score++;
    }
    
    foreach ($english_keywords as $k) {
        if (stripos($text, $k) !== false) $english_score++;
    }
    
    $hindi_chars = preg_match('/[\x{0900}-\x{097F}]/u', $text);
    if ($hindi_chars) $hindi_score += 3;
    
    return $hindi_score > $english_score ? 'hindi' : 'english';
}

function send_multilingual_response($chat_id, $message_type, $language) {
    $responses = [
        'hindi' => [
            'welcome' => "ğŸ¬ Boss, kis movie ki talash hai?",
            'found' => "âœ… Mil gayi! Movie forward ho rahi hai...",
            'not_found' => "ğŸ˜” Yeh movie abhi available nahi hai!\n\nğŸ“ Aap ise request kar sakte hain: " . REQUEST_CHANNEL . "\n\nğŸ”” Jab bhi yeh add hogi, main automatically bhej dunga!",
            'searching' => "ğŸ” Dhoondh raha hoon... Zara wait karo",
            'multiple_found' => "ğŸ¯ Kai versions mili hain! Aap konsi chahte hain?",
            'request_success' => "âœ… Request receive ho gayi! Hum jald hi add karenge.",
            'request_limit' => "âŒ Aaj ke liye aap maximum " . DAILY_REQUEST_LIMIT . " requests hi kar sakte hain."
        ],
        'english' => [
            'welcome' => "ğŸ¬ Boss, which movie are you looking for?",
            'found' => "âœ… Found it! Forwarding the movie...",
            'not_found' => "ğŸ˜” This movie isn't available yet!\n\nğŸ“ You can request it here: " . REQUEST_CHANNEL . "\n\nğŸ”” I'll send it automatically once it's added!",
            'searching' => "ğŸ” Searching... Please wait",
            'multiple_found' => "ğŸ¯ Multiple versions found! Which one do you want?",
            'request_success' => "âœ… Request received! We'll add it soon.",
            'request_limit' => "âŒ You've reached the daily limit of " . DAILY_REQUEST_LIMIT . " requests."
        ]
    ];
    
    sendMessage($chat_id, $responses[$language][$message_type]);
}

function advanced_search($chat_id, $query, $user_id = null) {
    global $movie_messages, $waiting_users;
    $q = strtolower(trim($query));
    
    if (strlen($q) < 2) {
        sendMessage($chat_id, "âŒ Please enter at least 2 characters for search");
        return;
    }
    
    $invalid_keywords = [
        'vlc', 'audio', 'track', 'change', 'open', 'kar', 'me', 'hai',
        'how', 'what', 'problem', 'issue', 'help', 'solution', 'fix',
        'error', 'not working', 'download', 'play', 'video', 'sound',
        'subtitle', 'quality', 'hd', 'full', 'part', 'scene',
        'hi', 'hello', 'hey', 'good', 'morning', 'night', 'bye',
        'thanks', 'thank', 'ok', 'okay', 'yes', 'no', 'maybe',
        'who', 'when', 'where', 'why', 'how', 'can', 'should',
        'kaise', 'kya', 'kahan', 'kab', 'kyun', 'kon', 'kisne',
        'hai', 'hain', 'ho', 'raha', 'raha', 'rah', 'tha', 'thi',
        'mere', 'apne', 'tumhare', 'hamare', 'sab', 'log', 'group'
    ];
    
    $query_words = explode(' ', $q);
    $total_words = count($query_words);
    
    $invalid_count = 0;
    foreach ($query_words as $word) {
        if (in_array($word, $invalid_keywords)) {
            $invalid_count++;
        }
    }
    
    if ($invalid_count > 0 && ($invalid_count / $total_words) > 0.5) {
        $help_msg = "ğŸ¬ Please enter a movie name!\n\n";
        $help_msg .= "ğŸ” Examples of valid movie names:\n";
        $help_msg .= "â€¢ kgf\nâ€¢ pushpa\nâ€¢ avengers\nâ€¢ hindi movie\nâ€¢ spider-man\n\n";
        $help_msg .= "âŒ Technical queries like 'vlc', 'audio track', etc. are not movie names.\n\n";
        $help_msg .= "ğŸ“¢ Join: " . MAIN_CHANNEL . "\n";
        $help_msg .= "ğŸ’¬ Help: " . REQUEST_CHANNEL;
        sendMessage($chat_id, $help_msg, null, 'HTML');
        return;
    }
    
    $movie_pattern = '/^[a-zA-Z0-9\s\-\.\,\&\+\(\)\:\'\"]+$/';
    if (!preg_match($movie_pattern, $query)) {
        sendMessage($chat_id, "âŒ Invalid movie name format. Only letters, numbers, and basic punctuation allowed.");
        return;
    }
    
    $found = smart_search($q);
    
    if (!empty($found)) {
        update_stats('successful_searches', 1);
        
        $msg = "ğŸ” Found " . count($found) . " movies for '$query':\n\n";
        $i = 1;
        foreach ($found as $movie => $data) {
            $quality_info = !empty($data['qualities']) ? implode('/', $data['qualities']) : 'Unknown';
            $msg .= "$i. $movie (" . $data['count'] . " versions, $quality_info)\n";
            $i++;
            if ($i > 10) break;
        }
        
        sendMessage($chat_id, $msg);
        
        $keyboard = ['inline_keyboard' => []];
        $top_movies = array_slice(array_keys($found), 0, 5);
        
        foreach ($top_movies as $movie) {
            $keyboard['inline_keyboard'][] = [[ 
                'text' => "ğŸ¬ " . ucwords($movie), 
                'callback_data' => $movie 
            ]];
        }
        
        $keyboard['inline_keyboard'][] = [[
            'text' => "ğŸ“ Request Different Movie", 
            'callback_data' => 'request_movie'
        ]];
        
        sendMessage($chat_id, "ğŸš€ Top matches (click to download):", $keyboard);
        
        if ($user_id) {
            update_user_activity($user_id, 'found_movie');
            update_user_activity($user_id, 'search');
        }
        
    } else {
        update_stats('failed_searches', 1);
        $lang = detect_language($query);
        send_multilingual_response($chat_id, 'not_found', $lang);
        
        $request_keyboard = [
            'inline_keyboard' => [[
                ['text' => 'ğŸ“ Request This Movie', 'callback_data' => 'auto_request_' . base64_encode($query)]
            ]]
        ];
        
        sendMessage($chat_id, "ğŸ’¡ Click below to automatically request this movie:", $request_keyboard);
        
        if (!isset($waiting_users[$q])) $waiting_users[$q] = [];
        $waiting_users[$q][] = [$chat_id, $user_id ?? $chat_id];
    }
    
    update_stats('total_searches', 1);
    if ($user_id) update_user_activity($user_id, 'search');
}

// ==============================
// STEP 12: MOVIE REQUEST SYSTEM
// ==============================
function can_user_request($user_id) {
    $requests_data = json_decode(file_get_contents(REQUEST_FILE), true);
    $today = date('Y-m-d');
    
    $user_requests_today = 0;
    foreach ($requests_data['requests'] ?? [] as $request) {
        if ($request['user_id'] == $user_id && $request['date'] == $today) {
            $user_requests_today++;
        }
    }
    
    return $user_requests_today < DAILY_REQUEST_LIMIT;
}

function add_movie_request($user_id, $movie_name, $language = 'hindi') {
    if (!can_user_request($user_id)) {
        return false;
    }
    
    $requests_data = json_decode(file_get_contents(REQUEST_FILE), true);
    
    $request_id = uniqid();
    $requests_data['requests'][] = [
        'id' => $request_id,
        'user_id' => $user_id,
        'movie_name' => $movie_name,
        'language' => $language,
        'date' => date('Y-m-d'),
        'time' => date('H:i:s'),
        'status' => 'pending'
    ];
    
    if (!isset($requests_data['user_request_count'][$user_id])) {
        $requests_data['user_request_count'][$user_id] = 0;
    }
    $requests_data['user_request_count'][$user_id]++;
    
    file_put_contents(REQUEST_FILE, json_encode($requests_data, JSON_PRETTY_PRINT));
    
    $admin_msg = "ğŸ¯ New Movie Request\n\n";
    $admin_msg .= "ğŸ¬ Movie: $movie_name\n";
    $admin_msg .= "ğŸ—£ï¸ Language: $language\n";
    $admin_msg .= "ğŸ‘¤ User ID: $user_id\n";
    $admin_msg .= "ğŸ“… Date: " . date('Y-m-d H:i:s') . "\n";
    $admin_msg .= "ğŸ†” Request ID: $request_id";
    
    sendMessage(ADMIN_ID, $admin_msg);
    bot_log("Movie request added: $movie_name by $user_id");
    
    return true;
}

// ==============================
// STEP 13: ENHANCED PAGINATION SYSTEM
// ==============================
function paginate_movies(array $all, int $page, array $filters = []): array {
    if (!empty($filters)) {
        $all = apply_movie_filters($all, $filters);
    }
    
    $total = count($all);
    if ($total === 0) {
        return [
            'total' => 0,
            'total_pages' => 1, 
            'page' => 1,
            'slice' => [],
            'filters' => $filters,
            'has_next' => false,
            'has_prev' => false,
            'start_item' => 0,
            'end_item' => 0
        ];
    }
    
    $total_pages = (int)ceil($total / ITEMS_PER_PAGE);
    $page = max(1, min($page, $total_pages));
    $start = ($page - 1) * ITEMS_PER_PAGE;
    
    return [
        'total' => $total,
        'total_pages' => $total_pages,
        'page' => $page,
        'slice' => array_slice($all, $start, ITEMS_PER_PAGE),
        'filters' => $filters,
        'has_next' => $page < $total_pages,
        'has_prev' => $page > 1,
        'start_item' => $start + 1,
        'end_item' => min($start + ITEMS_PER_PAGE, $total)
    ];
}

function apply_movie_filters($movies, $filters) {
    if (empty($filters)) return $movies;
    
    $filtered = [];
    foreach ($movies as $movie) {
        $pass = true;
        
        foreach ($filters as $key => $value) {
            switch ($key) {
                case 'quality':
                    if (stripos($movie['quality'] ?? '', $value) === false) {
                        $pass = false;
                    }
                    break;
                    
                case 'language':
                    if (stripos($movie['language'] ?? '', $value) === false) {
                        $pass = false;
                    }
                    break;
                    
                case 'year':
                    $movie_year = substr($movie['date'] ?? '', -4);
                    if ($movie_year != $value) {
                        $pass = false;
                    }
                    break;
                    
                case 'type':
                    if ($value == 'hd' && stripos($movie['quality'] ?? '', '1080') === false && stripos($movie['quality'] ?? '', '720') === false) {
                        $pass = false;
                    }
                    break;
            }
            
            if (!$pass) break;
        }
        
        if ($pass) {
            $filtered[] = $movie;
        }
    }
    
    return $filtered;
}

function build_enhanced_pagination_keyboard(int $page, int $total_pages, string $session_id = '', array $filters = []): array {
    $kb = ['inline_keyboard' => []];
    
    // ==================== PAGE NAVIGATION ROW ====================
    $nav_row = [];
    
    if ($page > 1) {
        $nav_row[] = ['text' => 'âª First', 'callback_data' => 'pag_first_' . $session_id];
        $nav_row[] = ['text' => 'â—€ï¸ Prev', 'callback_data' => 'pag_prev_' . $page . '_' . $session_id];
    }
    
    $start_page = max(1, $page - 3);
    $end_page = min($total_pages, $start_page + 6);
    
    if ($end_page - $start_page < 6) {
        $start_page = max(1, $end_page - 6);
    }
    
    for ($i = $start_page; $i <= $end_page; $i++) {
        if ($i == $page) {
            $nav_row[] = ['text' => "ã€{$i}ã€‘", 'callback_data' => 'current'];
        } else {
            $nav_row[] = ['text' => "{$i}", 'callback_data' => 'pag_' . $i . '_' . $session_id];
        }
    }
    
    if ($page < $total_pages) {
        $nav_row[] = ['text' => 'Next â–¶ï¸', 'callback_data' => 'pag_next_' . $page . '_' . $session_id];
        $nav_row[] = ['text' => 'Last â©', 'callback_data' => 'pag_last_' . $total_pages . '_' . $session_id];
    }
    
    if (!empty($nav_row)) {
        $kb['inline_keyboard'][] = $nav_row;
    }
    
    // ==================== ACTION BUTTONS ROW ====================
    $action_row = [];
    
    if (VIDEO_PREVIEW_ENABLED) {
        $action_row[] = ['text' => 'ğŸ¬ Video Preview', 'callback_data' => 'vidprev_' . $page . '_' . $session_id];
    }
    
    $action_row[] = ['text' => 'ğŸ“¥ Send Page', 'callback_data' => 'send_' . $page . '_' . $session_id];
    $action_row[] = ['text' => 'ğŸ‘ï¸ Text Preview', 'callback_data' => 'txtprev_' . $page . '_' . $session_id];
    
    $kb['inline_keyboard'][] = $action_row;
    
    // ==================== FILTER BUTTONS ROW ====================
    $filter_row = [];
    
    if (empty($filters)) {
        $filter_row[] = ['text' => 'ğŸ¬ HD Only', 'callback_data' => 'flt_hd_' . $session_id];
        $filter_row[] = ['text' => 'ğŸ”„ Latest', 'callback_data' => 'flt_new_' . $session_id];
        $filter_row[] = ['text' => 'ğŸ”¥ Popular', 'callback_data' => 'flt_pop_' . $session_id];
    } else {
        $filter_row[] = ['text' => 'ğŸ§¹ Clear Filter', 'callback_data' => 'flt_clr_' . $session_id];
        if (isset($filters['quality'])) {
            $filter_row[] = ['text' => 'âœ… ' . $filters['quality'], 'callback_data' => 'current'];
        }
    }
    
    $kb['inline_keyboard'][] = $filter_row;
    
    // ==================== CONTROL BUTTONS ROW ====================
    $ctrl_row = [];
    $ctrl_row[] = ['text' => 'ğŸ“Š Stats', 'callback_data' => 'stats_' . $session_id];
    $ctrl_row[] = ['text' => 'ğŸ” Search', 'switch_inline_query_current_chat' => ''];
    $ctrl_row[] = ['text' => 'âŒ Close', 'callback_data' => 'close_' . $session_id];
    
    $kb['inline_keyboard'][] = $ctrl_row;
    
    return $kb;
}

function enhanced_pagination_controller($chat_id, $page = 1, $filters = [], $session_id = null) {
    $all = get_cached_movies();
    
    if (empty($all)) {
        sendMessage($chat_id, "ğŸ“­ No movies found! Add some movies first.");
        return;
    }
    
    if (!$session_id) {
        $session_id = uniqid('sess_', true);
    }
    
    $pg = paginate_movies($all, (int)$page, $filters);
    
    $title = "ğŸ¬ <b>Enhanced Movie Browser</b>\n";
    $title .= "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
    
    $title .= "ğŸ†” <b>Session:</b> <code>" . substr($session_id, 0, 8) . "</code>\n";
    
    $title .= "ğŸ“Š <b>Statistics:</b>\n";
    $title .= "â€¢ Total Movies: <b>{$pg['total']}</b>\n";
    $title .= "â€¢ Page: <b>{$pg['page']}/{$pg['total_pages']}</b>\n";
    $title .= "â€¢ Items: <b>{$pg['start_item']}-{$pg['end_item']}</b>\n";
    
    if (!empty($filters)) {
        $title .= "â€¢ Filters: <b>" . count($filters) . " active</b>\n";
    }
    
    $title .= "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
    
    $title .= "ğŸ“‹ <b>Page {$page} Movies:</b>\n\n";
    $i = $pg['start_item'];
    
    foreach ($pg['slice'] as $movie) {
        $movie_name = htmlspecialchars($movie['movie_name'] ?? 'Unknown');
        $quality = $movie['quality'] ?? 'Unknown';
        $language = $movie['language'] ?? 'Hindi';
        $date = $movie['date'] ?? 'N/A';
        $size = $movie['size'] ?? 'Unknown';
        
        $quality_emoji = "ğŸ“±";
        if (stripos($quality, '1080') !== false) $quality_emoji = "ğŸ¥";
        elseif (stripos($quality, '720') !== false) $quality_emoji = "ğŸ“º";
        elseif (stripos($quality, '480') !== false) $quality_emoji = "ğŸ“¼";
        
        $lang_emoji = (stripos($language, 'hindi') !== false) ? "ğŸ‡®ğŸ‡³" : "ğŸ‡ºğŸ‡¸";
        
        $title .= "<b>{$i}.</b> {$movie_name}\n";
        $title .= "   {$quality_emoji} <b>{$quality}</b> | {$lang_emoji} {$language}\n";
        $title .= "   ğŸ’¾ {$size} | ğŸ“… {$date}\n\n";
        $i++;
    }
    
    $title .= "ğŸ“ <i>Click page numbers for direct access</i>\n";
    $title .= "ğŸ¬ <i>Try 'Video Preview' for movie clips</i>";
    
    $kb = build_enhanced_pagination_keyboard($pg['page'], $pg['total_pages'], $session_id, $filters);
    
    delete_pagination_message($chat_id, $session_id);
    
    $result = sendMessage($chat_id, $title, $kb, 'HTML');
    
    if (isset($result['result']['message_id'])) {
        save_pagination_message($chat_id, $session_id, $result['result']['message_id']);
        bot_log("Enhanced pagination - Chat: $chat_id, Page: $page, Session: " . substr($session_id, 0, 8));
    }
}

// ==============================
// STEP 14: VIDEO PREVIEW FUNCTION
// ==============================
function send_video_preview($chat_id, $page, $session_id) {
    $all = get_cached_movies();
    $pg = paginate_movies($all, (int)$page, []);
    
    if (empty($pg['slice'])) {
        sendMessage($chat_id, "âŒ No movies found on this page!");
        return;
    }
    
    $preview_count = min(MAX_VIDEO_PREVIEWS, count($pg['slice']));
    $movies_to_preview = array_slice($pg['slice'], 0, $preview_count);
    
    $preview_message = "ğŸ¬ <b>Video Preview - Page {$page}</b>\n";
    $preview_message .= "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
    $preview_message .= "Sending previews for first <b>{$preview_count}</b> movies:\n\n";
    
    $status_msg = sendMessage($chat_id, $preview_message, null, 'HTML');
    
    $success_count = 0;
    
    foreach ($movies_to_preview as $index => $movie) {
        $movie_name = htmlspecialchars($movie['movie_name'] ?? 'Unknown');
        $message_id = $movie['message_id'] ?? null;
        
        if ($message_id && is_numeric($message_id)) {
            try {
                $result = json_decode(copyMessage($chat_id, CHANNEL_ID, $message_id), true);
                
                if ($result && isset($result['ok']) && $result['ok']) {
                    $success_count++;
                    
                    $info_msg = "ğŸ¬ <b>Preview " . ($index + 1) . ":</b> {$movie_name}\n";
                    $info_msg .= "ğŸ“Š Quality: " . ($movie['quality'] ?? 'Unknown') . "\n";
                    $info_msg .= "ğŸ—£ï¸ Language: " . ($movie['language'] ?? 'Hindi') . "\n\n";
                    $info_msg .= "<i>Full movie available via search!</i>";
                    
                    sendMessage($chat_id, $info_msg, null, 'HTML');
                    sleep(1);
                }
            } catch (Exception $e) {
            }
        }
    }
    
    $completion_msg = "âœ… <b>Video Preview Complete</b>\n\n";
    $completion_msg .= "Page: {$page}\n";
    $completion_msg .= "Total movies: " . count($pg['slice']) . "\n";
    $completion_msg .= "Previews sent: {$success_count}/{$preview_count}\n\n";
    $completion_msg .= "ğŸ¯ <b>Use pagination to browse more!</b>";
    
    if (isset($status_msg['result']['message_id'])) {
        editMessage($chat_id, $status_msg['result']['message_id'], $completion_msg, null, 'HTML');
    } else {
        sendMessage($chat_id, $completion_msg, null, 'HTML');
    }
}

// ==============================
// STEP 15: TEXT PREVIEW FUNCTION
// ==============================
function send_text_preview($chat_id, $page, $session_id) {
    $all = get_cached_movies();
    $pg = paginate_movies($all, (int)$page, []);
    
    if (empty($pg['slice'])) {
        sendMessage($chat_id, "âŒ No movies found on this page!");
        return;
    }
    
    $preview_message = "ğŸ‘ï¸ <b>Text Preview - Page {$page}</b>\n";
    $preview_message .= "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
    
    $preview_count = min(PREVIEW_ITEMS, count($pg['slice']));
    
    foreach (array_slice($pg['slice'], 0, $preview_count) as $index => $movie) {
        $movie_name = htmlspecialchars($movie['movie_name'] ?? 'Unknown');
        $quality = $movie['quality'] ?? 'Unknown';
        $language = $movie['language'] ?? 'Hindi';
        $date = $movie['date'] ?? 'N/A';
        $size = $movie['size'] ?? 'Unknown';
        
        $preview_message .= "<b>" . ($index + 1) . ".</b> {$movie_name}\n";
        $preview_message .= "   ğŸ¬ Quality: {$quality}\n";
        $preview_message .= "   ğŸ—£ï¸ Language: {$language}\n";
        $preview_message .= "   ğŸ’¾ Size: {$size}\n";
        $preview_message .= "   ğŸ“… Date: {$date}\n\n";
    }
    
    if (count($pg['slice']) > $preview_count) {
        $remaining = count($pg['slice']) - $preview_count;
        $preview_message .= "ğŸ“‹ <i>And {$remaining} more movies on this page...</i>\n\n";
    }
    
    $preview_message .= "ğŸ¯ <b>Use 'Send Page' to get all movies!</b>";
    
    sendMessage($chat_id, $preview_message, null, 'HTML');
}

// ==============================
// STEP 16: BATCH DOWNLOAD FUNCTION
// ==============================
function batch_download_with_progress($chat_id, $movies, $page_num) {
    $total = count($movies);
    if ($total === 0) return;
    
    $progress_msg = sendMessage($chat_id, 
        "ğŸ“¦ <b>Batch Download Started</b>\n\n" .
        "ğŸ“„ Page: {$page_num}\n" .
        "ğŸ¬ Total: {$total} movies\n\n" .
        "â³ Initializing..."
    );
    
    if (!isset($progress_msg['result']['message_id'])) {
        return;
    }
    
    $progress_id = $progress_msg['result']['message_id'];
    $success = 0;
    $failed = 0;
    
    for ($i = 0; $i < $total; $i++) {
        $movie = $movies[$i];
        
        if ($i % 2 == 0) {
            $progress = round(($i / $total) * 100);
            $current_movie = htmlspecialchars(substr($movie['movie_name'] ?? 'Unknown', 0, 30));
            
            editMessage($chat_id, $progress_id, 
                "ğŸ“¦ <b>Downloading Page {$page_num}</b>\n\n" .
                "ğŸ“Š Progress: {$progress}%\n" .
                "ğŸ¬ Processed: {$i}/{$total}\n" .
                "âœ… Success: {$success}\n" .
                "âŒ Failed: {$failed}\n\n" .
                "â³ Current: {$current_movie}...\n\n" .
                "<i>Please wait...</i>"
            );
        }
        
        try {
            $message_id = $movie['message_id'] ?? null;
            if ($message_id && is_numeric($message_id)) {
                $result = json_decode(copyMessage($chat_id, CHANNEL_ID, $message_id), true);
                if ($result && isset($result['ok']) && $result['ok']) {
                    $success++;
                } else {
                    $failed++;
                }
            } else {
                $failed++;
            }
            
            usleep(500000);
            
        } catch (Exception $e) {
            $failed++;
        }
    }
    
    $success_rate = $total > 0 ? round(($success / $total) * 100, 2) : 0;
    
    editMessage($chat_id, $progress_id,
        "âœ… <b>Batch Download Complete</b>\n\n" .
        "ğŸ“„ Page: {$page_num}\n" .
        "ğŸ¬ Total Movies: {$total}\n" .
        "âœ… Successfully Sent: {$success}\n" .
        "âŒ Failed: {$failed}\n\n" .
        "ğŸ“Š Success Rate: {$success_rate}%\n" .
        "â±ï¸ Completed: " . date('H:i:s') . "\n\n" .
        "ğŸ¯ <b>Use pagination to browse more pages!</b>"
    );
}

// ==============================
// STEP 17: PAGINATION SESSION MANAGEMENT
// ==============================
function save_pagination_message($chat_id, $session_id, $message_id) {
    global $user_pagination_sessions;
    
    if (!isset($user_pagination_sessions[$session_id])) {
        $user_pagination_sessions[$session_id] = [];
    }
    
    $user_pagination_sessions[$session_id] = [
        'last_message_id' => $message_id,
        'chat_id' => $chat_id,
        'last_updated' => time(),
        'page' => 1,
        'filters' => []
    ];
}

function delete_pagination_message($chat_id, $session_id) {
    global $user_pagination_sessions;
    
    if (isset($user_pagination_sessions[$session_id]) && 
        isset($user_pagination_sessions[$session_id]['last_message_id'])) {
        
        $message_id = $user_pagination_sessions[$session_id]['last_message_id'];
        deleteMessage($chat_id, $message_id);
    }
}

function update_pagination_session($session_id, $page, $filters = []) {
    global $user_pagination_sessions;
    
    if (isset($user_pagination_sessions[$session_id])) {
        $user_pagination_sessions[$session_id]['page'] = $page;
        $user_pagination_sessions[$session_id]['filters'] = $filters;
        $user_pagination_sessions[$session_id]['last_updated'] = time();
    }
}

// ==============================
// STEP 18: BACKUP SYSTEM
// ==============================
function auto_backup() {
    bot_log("Starting auto-backup process...");
    
    $backup_files = [CSV_FILE, USERS_FILE, STATS_FILE, REQUEST_FILE, LOG_FILE];
    $backup_dir = BACKUP_DIR . date('Y-m-d_H-i-s');
    $backup_success = true;
    
    if (!file_exists($backup_dir)) {
        mkdir($backup_dir, 0777, true);
    }
    
    foreach ($backup_files as $file) {
        if (file_exists($file)) {
            $backup_path = $backup_dir . '/' . basename($file) . '.bak';
            if (!copy($file, $backup_path)) {
                bot_log("Failed to backup: $file", 'ERROR');
                $backup_success = false;
            } else {
                bot_log("Backed up: $file");
            }
        }
    }
    
    $summary = create_backup_summary();
    file_put_contents($backup_dir . '/backup_summary.txt', $summary);
    
    if ($backup_success) {
        $channel_backup_success = upload_backup_to_channel($backup_dir, $summary);
        
        if ($channel_backup_success) {
            bot_log("Backup successfully uploaded to channel");
        } else {
            bot_log("Failed to upload backup to channel", 'WARNING');
        }
    }
    
    clean_old_backups();
    send_backup_report($backup_success, $summary);
    
    bot_log("Auto-backup process completed");
    return $backup_success;
}

function create_backup_summary() {
    $stats = get_stats();
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    $requests_data = json_decode(file_get_contents(REQUEST_FILE), true);
    
    $summary = "ğŸ“Š BACKUP SUMMARY\n";
    $summary .= "================\n\n";
    
    $summary .= "ğŸ“… Backup Date: " . date('Y-m-d H:i:s') . "\n";
    $summary .= "ğŸ¤– Bot: Entertainment Tadka\n\n";
    
    $summary .= "ğŸ“ˆ STATISTICS:\n";
    $summary .= "â€¢ Total Movies: " . ($stats['total_movies'] ?? 0) . "\n";
    $summary .= "â€¢ Total Users: " . count($users_data['users'] ?? []) . "\n";
    $summary .= "â€¢ Total Searches: " . ($stats['total_searches'] ?? 0) . "\n";
    $summary .= "â€¢ Total Downloads: " . ($stats['total_downloads'] ?? 0) . "\n";
    $summary .= "â€¢ Pending Requests: " . count($requests_data['requests'] ?? []) . "\n\n";
    
    $summary .= "ğŸ’¾ FILES BACKED UP:\n";
    $summary .= "â€¢ " . CSV_FILE . " (" . (file_exists(CSV_FILE) ? filesize(CSV_FILE) : 0) . " bytes)\n";
    $summary .= "â€¢ " . USERS_FILE . " (" . (file_exists(USERS_FILE) ? filesize(USERS_FILE) : 0) . " bytes)\n";
    $summary .= "â€¢ " . STATS_FILE . " (" . (file_exists(STATS_FILE) ? filesize(STATS_FILE) : 0) . " bytes)\n";
    $summary .= "â€¢ " . REQUEST_FILE . " (" . (file_exists(REQUEST_FILE) ? filesize(REQUEST_FILE) : 0) . " bytes)\n";
    $summary .= "â€¢ " . LOG_FILE . " (" . (file_exists(LOG_FILE) ? filesize(LOG_FILE) : 0) . " bytes)\n\n";
    
    $summary .= "ğŸ”„ Backup Type: Automated Daily Backup\n";
    $summary .= "ğŸ“ Stored In: " . BACKUP_DIR . "\n";
    $summary .= "ğŸ“¡ Channel: " . BACKUP_CHANNEL_USERNAME . "\n";
    
    return $summary;
}

function upload_backup_to_channel($backup_dir, $summary) {
    try {
        $summary_message = "ğŸ”„ <b>Daily Auto-Backup Report</b>\n\n";
        $summary_message .= "ğŸ“… " . date('Y-m-d H:i:s') . "\n\n";
        
        $stats = get_stats();
        $users_data = json_decode(file_get_contents(USERS_FILE), true);
        
        $summary_message .= "ğŸ“Š <b>Current Stats:</b>\n";
        $summary_message .= "â€¢ ğŸ¬ Movies: " . ($stats['total_movies'] ?? 0) . "\n";
        $summary_message .= "â€¢ ğŸ‘¥ Users: " . count($users_data['users'] ?? []) . "\n";
        $summary_message .= "â€¢ ğŸ” Searches: " . ($stats['total_searches'] ?? 0) . "\n";
        $summary_message .= "â€¢ ğŸ“¥ Downloads: " . ($stats['total_downloads'] ?? 0) . "\n\n";
        
        $summary_message .= "âœ… <b>Backup Status:</b> Successful\n";
        $summary_message .= "ğŸ“ <b>Location:</b> " . $backup_dir . "\n";
        $summary_message .= "ğŸ’¾ <b>Files:</b> 5 data files\n";
        $summary_message .= "ğŸ“¡ <b>Channel:</b> " . BACKUP_CHANNEL_USERNAME . "\n\n";
        
        $summary_message .= "ğŸ”— <a href=\"https://t.me/ETBackup\">Visit Backup Channel</a>";

        $keyboard = [
            'inline_keyboard' => [
                [
                    ['text' => 'ğŸ“¡ Visit ' . BACKUP_CHANNEL_USERNAME, 'url' => 'https://t.me/ETBackup']
                ]
            ]
        ];
        
        $message_result = sendMessage(BACKUP_CHANNEL_ID, $summary_message, $keyboard, 'HTML');
        
        if (!$message_result || !isset($message_result['ok']) || !$message_result['ok']) {
            bot_log("Failed to send backup summary to channel", 'ERROR');
            return false;
        }
        
        $critical_files = [
            CSV_FILE => "ğŸ¬ Movies Database",
            USERS_FILE => "ğŸ‘¥ Users Data", 
            STATS_FILE => "ğŸ“Š Bot Statistics",
            REQUEST_FILE => "ğŸ“ Movie Requests"
        ];
        
        foreach ($critical_files as $file => $description) {
            if (file_exists($file)) {
                $upload_success = upload_file_to_channel($file, $backup_dir, $description);
                if (!$upload_success) {
                    bot_log("Failed to upload $file to channel", 'WARNING');
                }
                sleep(2);
            }
        }
        
        $zip_success = create_and_upload_zip($backup_dir);
        
        $completion_message = "âœ… <b>Backup Process Completed</b>\n\n";
        $completion_message .= "ğŸ“… " . date('Y-m-d H:i:s') . "\n";
        $completion_message .= "ğŸ’¾ All files backed up successfully\n";
        $completion_message .= "ğŸ“¦ Zip archive created\n";
        $completion_message .= "ğŸ“¡ Uploaded to: " . BACKUP_CHANNEL_USERNAME . "\n\n";
        $completion_message .= "ğŸ›¡ï¸ <i>Your data is now securely backed up!</i>";
        
        sendMessage(BACKUP_CHANNEL_ID, $completion_message, null, 'HTML');
        
        return true;
        
    } catch (Exception $e) {
        bot_log("Channel backup failed: " . $e->getMessage(), 'ERROR');
        
        $error_message = "âŒ <b>Backup Process Failed</b>\n\n";
        $error_message .= "ğŸ“… " . date('Y-m-d H:i:s') . "\n";
        $error_message .= "ğŸš¨ Error: " . $e->getMessage() . "\n\n";
        $error_message .= "âš ï¸ Please check server logs immediately!";
        
        sendMessage(BACKUP_CHANNEL_ID, $error_message, null, 'HTML');
        
        return false;
    }
}

function upload_file_to_channel($file_path, $backup_dir, $description = "") {
    if (!file_exists($file_path)) {
        return false;
    }
    
    $file_name = basename($file_path);
    $backup_file_path = $backup_dir . '/' . $file_name . '.bak';
    
    if (!file_exists($backup_file_path)) {
        return false;
    }
    
    $file_size = filesize($backup_file_path);
    $file_size_mb = round($file_size / (1024 * 1024), 2);
    $backup_time = date('Y-m-d H:i:s');
    
    $caption = "ğŸ’¾ " . $description . "\n";
    $caption .= "ğŸ“… " . $backup_time . "\n";
    $caption .= "ğŸ“Š Size: " . $file_size_mb . " MB\n";
    $caption .= "ğŸ”„ Auto-backup\n";
    $caption .= "ğŸ“¡ " . BACKUP_CHANNEL_USERNAME;
    
    if ($file_size > 45 * 1024 * 1024) {
        bot_log("File too large for Telegram: $file_name ($file_size_mb MB)", 'WARNING');
        
        if ($file_name == 'movies.csv') {
            return split_and_upload_large_csv($backup_file_path, $backup_dir, $description);
        }
        return false;
    }
    
    $post_fields = [
        'chat_id' => BACKUP_CHANNEL_ID,
        'document' => new CURLFile($backup_file_path),
        'caption' => $caption,
        'parse_mode' => 'HTML'
    ];
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "https://api.telegram.org/bot" . BOT_TOKEN . "/sendDocument");
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $post_fields);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $result = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    $result_data = json_decode($result, true);
    $success = ($http_code == 200 && $result_data && $result_data['ok']);
    
    if ($success) {
        bot_log("Uploaded to channel: $file_name");
        
        if ($file_size > 10 * 1024 * 1024) {
            $confirmation = "âœ… <b>Large File Uploaded</b>\n\n";
            $confirmation .= "ğŸ“ File: " . $description . "\n";
            $confirmation .= "ğŸ’¾ Size: " . $file_size_mb . " MB\n";
            $confirmation .= "âœ… Status: Successfully uploaded to " . BACKUP_CHANNEL_USERNAME;
            sendMessage(BACKUP_CHANNEL_ID, $confirmation, null, 'HTML');
        }
    } else {
        bot_log("Failed to upload to channel: $file_name", 'ERROR');
    }
    
    return $success;
}

function split_and_upload_large_csv($csv_file_path, $backup_dir, $description) {
    if (!file_exists($csv_file_path)) {
        return false;
    }
    
    $file_size = filesize($csv_file_path);
    $file_size_mb = round($file_size / (1024 * 1024), 2);
    
    bot_log("Splitting large CSV file: $file_size_mb MB", 'INFO');
    
    $rows = [];
    $handle = fopen($csv_file_path, 'r');
    if ($handle !== FALSE) {
        $header = fgetcsv($handle);
        while (($row = fgetcsv($handle)) !== FALSE) {
            $rows[] = $row;
        }
        fclose($handle);
    }
    
    $total_rows = count($rows);
    $rows_per_file = ceil($total_rows / 3);
    
    $upload_success = true;
    
    for ($i = 0; $i < 3; $i++) {
        $start = $i * $rows_per_file;
        $end = min($start + $rows_per_file, $total_rows);
        $part_rows = array_slice($rows, $start, $end - $start);
        
        $part_file = $backup_dir . '/movies_part_' . ($i + 1) . '.csv';
        $part_handle = fopen($part_file, 'w');
        fputcsv($part_handle, $header);
        foreach ($part_rows as $row) {
            fputcsv($part_handle, $row);
        }
        fclose($part_handle);
        
        $part_caption = "ğŸ’¾ " . $description . " (Part " . ($i + 1) . "/3)\n";
        $part_caption .= "ğŸ“… " . date('Y-m-d H:i:s') . "\n";
        $part_caption .= "ğŸ“Š Rows: " . count($part_rows) . "\n";
        $part_caption .= "ğŸ”„ Split backup\n";
        $part_caption .= "ğŸ“¡ " . BACKUP_CHANNEL_USERNAME;
        
        $post_fields = [
            'chat_id' => BACKUP_CHANNEL_ID,
            'document' => new CURLFile($part_file),
            'caption' => $part_caption,
            'parse_mode' => 'HTML'
        ];
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, "https://api.telegram.org/bot" . BOT_TOKEN . "/sendDocument");
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_fields);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        
        $result = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        @unlink($part_file);
        
        if ($http_code != 200) {
            $upload_success = false;
            bot_log("Failed to upload CSV part " . ($i + 1), 'ERROR');
        } else {
            bot_log("Uploaded CSV part " . ($i + 1));
        }
        
        sleep(2);
    }
    
    if ($upload_success) {
        $split_message = "ğŸ“¦ <b>Large CSV Split Successfully</b>\n\n";
        $split_message .= "ğŸ“ File: " . $description . "\n";
        $split_message .= "ğŸ’¾ Original Size: " . $file_size_mb . " MB\n";
        $split_message .= "ğŸ“Š Total Rows: " . $total_rows . "\n";
        $split_message .= "ğŸ”€ Split into: 3 parts\n";
        $split_message .= "âœ… All parts uploaded to " . BACKUP_CHANNEL_USERNAME;
        
        sendMessage(BACKUP_CHANNEL_ID, $split_message, null, 'HTML');
    }
    
    return $upload_success;
}

function create_and_upload_zip($backup_dir) {
    $zip_file = $backup_dir . '/complete_backup.zip';
    $zip = new ZipArchive();
    
    if ($zip->open($zip_file, ZipArchive::CREATE) !== TRUE) {
        bot_log("Cannot open zip file: $zip_file", 'ERROR');
        return false;
    }
    
    $files = glob($backup_dir . '/*.bak');
    foreach ($files as $file) {
        $zip->addFile($file, basename($file));
    }
    
    if (file_exists($backup_dir . '/backup_summary.txt')) {
        $zip->addFile($backup_dir . '/backup_summary.txt', 'backup_summary.txt');
    }
    
    $zip->close();
    
    $zip_size = filesize($zip_file);
    $zip_size_mb = round($zip_size / (1024 * 1024), 2);
    
    $caption = "ğŸ“¦ Complete Backup Archive\n";
    $caption .= "ğŸ“… " . date('Y-m-d H:i:s') . "\n";
    $caption .= "ğŸ’¾ Size: " . $zip_size_mb . " MB\n";
    $caption .= "ğŸ“ Contains all data files\n";
    $caption .= "ğŸ”„ Auto-generated backup\n";
    $caption .= "ğŸ“¡ " . BACKUP_CHANNEL_USERNAME;
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ”— ' . BACKUP_CHANNEL_USERNAME, 'url' => 'https://t.me/ETBackup']
            ]
        ]
    ];
    
    $post_fields = [
        'chat_id' => BACKUP_CHANNEL_ID,
        'document' => new CURLFile($zip_file),
        'caption' => $caption,
        'parse_mode' => 'HTML'
    ];
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, "https://api.telegram.org/bot" . BOT_TOKEN . "/sendDocument");
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $post_fields);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 60);
    
    $result = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    @unlink($zip_file);
    
    $success = ($http_code == 200);
    
    if ($success) {
        bot_log("Zip backup uploaded to channel successfully");
        
        $zip_confirmation = "âœ… <b>Zip Archive Uploaded</b>\n\n";
        $zip_confirmation .= "ğŸ“¦ File: Complete Backup Archive\n";
        $zip_confirmation .= "ğŸ’¾ Size: " . $zip_size_mb . " MB\n";
        $zip_confirmation .= "âœ… Status: Successfully uploaded\n";
        $zip_confirmation .= "ğŸ“¡ Channel: " . BACKUP_CHANNEL_USERNAME . "\n\n";
        $zip_confirmation .= "ğŸ›¡ï¸ <i>All data securely backed up!</i>";
        
        sendMessage(BACKUP_CHANNEL_ID, $zip_confirmation, $keyboard, 'HTML');
    } else {
        bot_log("Failed to upload zip backup to channel", 'WARNING');
    }
    
    return $success;
}

function clean_old_backups() {
    $old = glob(BACKUP_DIR . '*', GLOB_ONLYDIR);
    if (count($old) > 7) {
        usort($old, function($a, $b) {
            return filemtime($a) - filemtime($b);
        });
        
        $deleted_count = 0;
        foreach (array_slice($old, 0, count($old) - 7) as $d) {
            $files = glob($d . '/*');
            foreach ($files as $ff) @unlink($ff);
            if (@rmdir($d)) {
                $deleted_count++;
                bot_log("Deleted old backup: $d");
            }
        }
        
        bot_log("Cleaned $deleted_count old backups");
    }
}

function send_backup_report($success, $summary) {
    $report_message = "ğŸ”„ <b>Backup Completion Report</b>\n\n";
    
    if ($success) {
        $report_message .= "âœ… <b>Status:</b> SUCCESS\n";
        $report_message .= "ğŸ“… <b>Time:</b> " . date('Y-m-d H:i:s') . "\n";
        $report_message .= "ğŸ“¡ <b>Channel:</b> " . BACKUP_CHANNEL_USERNAME . "\n\n";
    } else {
        $report_message .= "âŒ <b>Status:</b> FAILED\n";
        $report_message .= "ğŸ“… <b>Time:</b> " . date('Y-m-d H:i:s') . "\n";
        $report_message .= "ğŸ“¡ <b>Channel:</b> " . BACKUP_CHANNEL_USERNAME . "\n\n";
        $report_message .= "âš ï¸ Some backup operations may have failed. Check logs for details.\n\n";
    }
    
    $stats = get_stats();
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    
    $report_message .= "ğŸ“Š <b>Current System Status:</b>\n";
    $report_message .= "â€¢ ğŸ¬ Movies: " . ($stats['total_movies'] ?? 0) . "\n";
    $report_message .= "â€¢ ğŸ‘¥ Users: " . count($users_data['users'] ?? []) . "\n";
    $report_message .= "â€¢ ğŸ” Searches: " . ($stats['total_searches'] ?? 0) . "\n";
    $report_message .= "â€¢ ğŸ“¥ Downloads: " . ($stats['total_downloads'] ?? 0) . "\n\n";
    
    $report_message .= "ğŸ’¾ <b>Backup Locations:</b>\n";
    $report_message .= "â€¢ Local: " . BACKUP_DIR . "\n";
    $report_message .= "â€¢ Channel: " . BACKUP_CHANNEL_USERNAME . "\n\n";
    
    $report_message .= "ğŸ•’ <b>Next Backup:</b> " . AUTO_BACKUP_HOUR . ":00 daily";
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“¡ Visit Backup Channel', 'url' => 'https://t.me/ETBackup'],
                ['text' => 'ğŸ“Š Backup Status', 'callback_data' => 'backup_status']
            ]
        ]
    ];
    
    sendMessage(ADMIN_ID, $report_message, $keyboard, 'HTML');
}

// ==============================
// STEP 19: MANUAL BACKUP COMMANDS
// ==============================
function manual_backup($chat_id) {
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    $progress_msg = sendMessage($chat_id, "ğŸ”„ Starting manual backup...");
    
    try {
        $success = auto_backup();
        
        if ($success) {
            editMessage($chat_id, $progress_msg['result']['message_id'], "âœ… Manual backup completed successfully!\n\nğŸ“Š Backup has been saved locally and uploaded to backup channel.");
        } else {
            editMessage($chat_id, $progress_msg['result']['message_id'], "âš ï¸ Backup completed with some warnings.\n\nSome files may not have been backed up properly. Check logs for details.");
        }
        
    } catch (Exception $e) {
        editMessage($chat_id, $progress_msg['result']['message_id'], "âŒ Backup failed!\n\nError: " . $e->getMessage());
        bot_log("Manual backup failed: " . $e->getMessage(), 'ERROR');
    }
}

function quick_backup($chat_id) {
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    $progress_msg = sendMessage($chat_id, "ğŸ’¾ Creating quick backup...");
    
    try {
        $essential_files = [CSV_FILE, USERS_FILE];
        $backup_dir = BACKUP_DIR . 'quick_' . date('Y-m-d_H-i-s');
        
        if (!file_exists($backup_dir)) {
            mkdir($backup_dir, 0777, true);
        }
        
        foreach ($essential_files as $file) {
            if (file_exists($file)) {
                copy($file, $backup_dir . '/' . basename($file) . '.bak');
            }
        }
        
        $summary = "ğŸš€ Quick Backup\n" . date('Y-m-d H:i:s') . "\nEssential files only";
        file_put_contents($backup_dir . '/quick_backup_info.txt', $summary);
        
        foreach ($essential_files as $file) {
            $backup_file = $backup_dir . '/' . basename($file) . '.bak';
            if (file_exists($backup_file)) {
                upload_file_to_channel($file, $backup_dir);
                sleep(1);
            }
        }
        
        editMessage($chat_id, $progress_msg['result']['message_id'], "âœ… Quick backup completed!\n\nEssential files backed up to channel.");
        
    } catch (Exception $e) {
        editMessage($chat_id, $progress_msg['result']['message_id'], "âŒ Quick backup failed!\n\nError: " . $e->getMessage());
    }
}

// ==============================
// STEP 20: BACKUP STATUS & INFO COMMANDS
// ==============================
function backup_status($chat_id) {
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    $backup_dirs = glob(BACKUP_DIR . '*', GLOB_ONLYDIR);
    $latest_backup = null;
    $total_size = 0;
    
    if (!empty($backup_dirs)) {
        usort($backup_dirs, function($a, $b) {
            return filemtime($b) - filemtime($a);
        });
        $latest_backup = $backup_dirs[0];
    }
    
    foreach ($backup_dirs as $dir) {
        $files = glob($dir . '/*');
        foreach ($files as $file) {
            $total_size += filesize($file);
        }
    }
    
    $total_size_mb = round($total_size / (1024 * 1024), 2);
    
    $status_message = "ğŸ’¾ <b>Backup System Status</b>\n\n";
    
    $status_message .= "ğŸ“Š <b>Storage Info:</b>\n";
    $status_message .= "â€¢ Total Backups: " . count($backup_dirs) . "\n";
    $status_message .= "â€¢ Storage Used: " . $total_size_mb . " MB\n";
    $status_message .= "â€¢ Backup Channel: " . BACKUP_CHANNEL_USERNAME . "\n";
    $status_message .= "â€¢ Channel ID: " . BACKUP_CHANNEL_ID . "\n\n";
    
    if ($latest_backup) {
        $latest_time = date('Y-m-d H:i:s', filemtime($latest_backup));
        $status_message .= "ğŸ•’ <b>Latest Backup:</b>\n";
        $status_message .= "â€¢ Time: " . $latest_time . "\n";
        $status_message .= "â€¢ Folder: " . basename($latest_backup) . "\n\n";
    } else {
        $status_message .= "âŒ <b>No backups found!</b>\n\n";
    }
    
    $status_message .= "â° <b>Auto-backup Schedule:</b>\n";
    $status_message .= "â€¢ Daily at " . AUTO_BACKUP_HOUR . ":00\n";
    $status_message .= "â€¢ Keep last 7 backups\n";
    $status_message .= "â€¢ Upload to " . BACKUP_CHANNEL_USERNAME . "\n\n";
    
    $status_message .= "ğŸ› ï¸ <b>Manual Commands:</b>\n";
    $status_message .= "â€¢ <code>/backup</code> - Full backup\n";
    $status_message .= "â€¢ <code>/quickbackup</code> - Quick backup\n";
    $status_message .= "â€¢ <code>/backupstatus</code> - This info\n\n";
    
    $status_message .= "ğŸ”— <b>Backup Channel:</b> " . BACKUP_CHANNEL_USERNAME;
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“¡ Visit ' . BACKUP_CHANNEL_USERNAME, 'url' => 'https://t.me/ETBackup'],
                ['text' => 'ğŸ”„ Run Backup', 'callback_data' => 'run_backup']
            ]
        ]
    ];
    
    sendMessage($chat_id, $status_message, $keyboard, 'HTML');
}

// ==============================
// STEP 21: CHANNEL MANAGEMENT FUNCTIONS
// ==============================
function show_channel_info($chat_id) {
    $message = "ğŸ“¢ <b>Join Our Channels</b>\n\n";
    
    $message .= "ğŸ¿ <b>Main Channel:</b> " . MAIN_CHANNEL . "\n";
    $message .= "â€¢ Latest movie updates\n";
    $message .= "â€¢ Daily new additions\n";
    $message .= "â€¢ High quality prints\n";
    $message .= "â€¢ Direct downloads\n\n";
    
    $message .= "ğŸ“¥ <b>Requests Channel:</b> " . REQUEST_CHANNEL . "\n";
    $message .= "â€¢ Movie requests\n";
    $message .= "â€¢ Bug reports\n";
    $message .= "â€¢ Feature suggestions\n";
    $message .= "â€¢ Support & help\n\n";
    
    $message .= "ğŸ”’ <b>Backup Channel:</b> " . BACKUP_CHANNEL_USERNAME . "\n";
    $message .= "â€¢ Secure data backups\n";
    $message .= "â€¢ System archives\n";
    $message .= "â€¢ Database copies\n";
    $message .= "â€¢ Admin only access\n\n";
    
    $message .= "ğŸ­ <b>Theater Print Channel:</b> " . THEATER_PRINT_CHANNEL . "\n";
    $message .= "â€¢ Theater quality prints\n";
    $message .= "â€¢ Early releases\n";
    $message .= "â€¢ Exclusive content\n\n";
    
    $message .= "ğŸ”” <b>Don't forget to join all channels!</b>";

    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ¿ ' . MAIN_CHANNEL, 'url' => 'https://t.me/EntertainmentTadka786'],
                ['text' => 'ğŸ“¥ ' . REQUEST_CHANNEL, 'url' => 'https://t.me/EntertainmentTadka7860']
            ],
            [
                ['text' => 'ğŸ­ ' . THEATER_PRINT_CHANNEL, 'url' => 'https://t.me/threater_print_movies'],
                ['text' => 'ğŸ”’ ' . BACKUP_CHANNEL_USERNAME, 'url' => 'https://t.me/ETBackup']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

function show_main_channel_info($chat_id) {
    $message = "ğŸ¿ <b>Main Channel - " . MAIN_CHANNEL . "</b>\n\n";
    
    $message .= "ğŸ¬ <b>What you get:</b>\n";
    $message .= "â€¢ Latest Bollywood & Hollywood movies\n";
    $message .= "â€¢ HD/1080p/720p quality prints\n";
    $message .= "â€¢ Daily new uploads\n";
    $message .= "â€¢ Multiple server links\n";
    $message .= "â€¢ Fast direct downloads\n";
    $message .= "â€¢ No ads, no spam\n\n";
    
    $message .= "ğŸ“Š <b>Current Stats:</b>\n";
    $stats = get_stats();
    $message .= "â€¢ Total Movies: " . ($stats['total_movies'] ?? 0) . "\n";
    $message .= "â€¢ Active Users: " . get_active_users_count() . "\n";
    $message .= "â€¢ Daily Uploads: " . get_daily_uploads_count() . "\n\n";
    
    $message .= "ğŸ”” <b>Join now for latest movies!</b>";

    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ¿ Join Main Channel', 'url' => 'https://t.me/EntertainmentTadka786'],
                ['text' => 'ğŸ“¥ Request Movies', 'url' => 'https://t.me/EntertainmentTadka7860']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

function show_request_channel_info($chat_id) {
    $message = "ğŸ“¥ <b>Requests Channel - " . REQUEST_CHANNEL . "</b>\n\n";
    
    $message .= "ğŸ¯ <b>How to request movies:</b>\n";
    $message .= "1. Join this channel first\n";
    $message .= "2. Use <code>/request movie_name</code> in bot\n";
    $message .= "3. Or post directly in channel\n";
    $message .= "4. We'll add within 24 hours\n\n";
    
    $message .= "ğŸ“ <b>Also available:</b>\n";
    $message .= "â€¢ Bug reports & issues\n";
    $message .= "â€¢ Feature suggestions\n";
    $message .= "â€¢ General support\n";
    $message .= "â€¢ Bot help & guidance\n\n";
    
    $message .= "âš ï¸ <b>Please check these before requesting:</b>\n";
    $message .= "â€¢ Search in bot first\n";
    $message .= "â€¢ Check spelling\n";
    $message .= "â€¢ Use correct movie name\n";
    $message .= "â€¢ Be patient for uploads\n\n";
    
    $message .= "ğŸš€ <b>We fulfill most requests within 24 hours!</b>";

    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“¥ Join Requests Channel', 'url' => 'https://t.me/EntertainmentTadka7860'],
                ['text' => 'ğŸ¬ Request via Bot', 'callback_data' => 'request_help']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

function show_backup_channel_info($chat_id) {
    $message = "ğŸ”’ <b>Backup Channel - " . BACKUP_CHANNEL_USERNAME . "</b>\n\n";
    
    $message .= "ğŸ›¡ï¸ <b>Purpose:</b>\n";
    $message .= "â€¢ Secure data backups\n";
    $message .= "â€¢ Database protection\n";
    $message .= "â€¢ System recovery\n";
    $message .= "â€¢ Disaster prevention\n\n";
    
    $message .= "ğŸ’¾ <b>What's backed up:</b>\n";
    $message .= "â€¢ Movies database (" . get_csv_count() . " movies)\n";
    $message .= "â€¢ Users data (" . get_users_count() . " users)\n";
    $message .= "â€¢ Bot statistics\n";
    $message .= "â€¢ Request history\n";
    $message .= "â€¢ Complete system archives\n\n";
    
    $message .= "â° <b>Backup Schedule:</b>\n";
    $message .= "â€¢ Automatic: Daily at " . AUTO_BACKUP_HOUR . ":00\n";
    $message .= "â€¢ Manual: On admin command\n";
    $message .= "â€¢ Retention: Last 7 backups\n\n";
    
    $message .= "ğŸ” <b>Note:</b> This is a private channel for admin use only.";

    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ”’ ' . BACKUP_CHANNEL_USERNAME, 'url' => 'https://t.me/ETBackup'],
                ['text' => 'ğŸ“Š Backup Status', 'callback_data' => 'backup_status']
            ]
        ]
    ];
    
    if ($chat_id == ADMIN_ID) {
        sendMessage($chat_id, $message, $keyboard, 'HTML');
    } else {
        sendMessage($chat_id, "ğŸ”’ <b>Backup Channel</b>\n\nThis is a private admin-only channel for data protection.", null, 'HTML');
    }
}

function show_theater_print_channel_info($chat_id) {
    $message = "ğŸ­ <b>Theater Print Channel - " . THEATER_PRINT_CHANNEL . "</b>\n\n";
    
    $message .= "ğŸ¬ <b>What you get:</b>\n";
    $message .= "â€¢ Theater quality prints\n";
    $message .= "â€¢ Early movie releases\n";
    $message .= "â€¢ Exclusive content\n";
    $message .= "â€¢ HD/4K quality\n";
    $message .= "â€¢ Fast downloads\n\n";
    
    $message .= "ğŸ“¥ <b>How to access:</b>\n";
    $message .= "1. Join the channel\n";
    $message .= "2. Search movies via bot\n";
    $message .= "3. Download directly\n\n";
    
    $message .= "ğŸ”” <b>New Feature:</b>\n";
    $message .= "Request group gets notified when new movies are uploaded!";

    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ­ Join Theater Prints', 'url' => 'https://t.me/threater_print_movies'],
                ['text' => 'ğŸ¿ Main Channel', 'url' => 'https://t.me/EntertainmentTadka786']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

// ==============================
// STEP 22: HELPER FUNCTIONS FOR CHANNEL INFO
// ==============================
function get_active_users_count() {
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    $active_count = 0;
    $one_week_ago = strtotime('-1 week');
    
    foreach ($users_data['users'] ?? [] as $user) {
        if (strtotime($user['last_active'] ?? '') >= $one_week_ago) {
            $active_count++;
        }
    }
    
    return $active_count;
}

function get_daily_uploads_count() {
    $today = date('d-m-Y');
    $count = 0;
    
    $handle = fopen(CSV_FILE, 'r');
    if ($handle !== FALSE) {
        fgetcsv($handle);
        while (($row = fgetcsv($handle)) !== FALSE) {
            if (count($row) >= 3 && $row[2] == $today) {
                $count++;
            }
        }
        fclose($handle);
    }
    
    return $count;
}

function get_csv_count() {
    $count = 0;
    
    $handle = fopen(CSV_FILE, 'r');
    if ($handle !== FALSE) {
        fgetcsv($handle);
        while (($row = fgetcsv($handle)) !== FALSE) {
            if (count($row) >= 3 && !empty(trim($row[0]))) {
                $count++;
            }
        }
        fclose($handle);
    }
    
    return $count;
}

function get_users_count() {
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    return count($users_data['users'] ?? []);
}

// ==============================
// STEP 23: USER STATS & LEADERBOARD FUNCTIONS
// ==============================
function show_user_stats($chat_id, $user_id) {
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    $user = $users_data['users'][$user_id] ?? null;
    
    if (!$user) {
        sendMessage($chat_id, "âŒ User data not found!");
        return;
    }
    
    $message = "ğŸ‘¤ <b>Your Statistics</b>\n\n";
    $message .= "ğŸ†” User ID: <code>$user_id</code>\n";
    $message .= "ğŸ“… Joined: " . ($user['joined'] ?? 'N/A') . "\n";
    $message .= "ğŸ•’ Last Active: " . ($user['last_active'] ?? 'N/A') . "\n\n";
    
    $message .= "ğŸ“Š <b>Activity:</b>\n";
    $message .= "â€¢ ğŸ” Searches: " . ($user['total_searches'] ?? 0) . "\n";
    $message .= "â€¢ ğŸ“¥ Downloads: " . ($user['total_downloads'] ?? 0) . "\n";
    $message .= "â€¢ ğŸ“ Requests: " . ($user['request_count'] ?? 0) . "\n";
    $message .= "â€¢ â­ Points: " . ($user['points'] ?? 0) . "\n\n";
    
    $message .= "ğŸ¯ <b>Rank:</b> " . calculate_user_rank($user['points'] ?? 0);
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“ˆ Leaderboard', 'callback_data' => 'show_leaderboard'],
                ['text' => 'ğŸ”„ Refresh', 'callback_data' => 'refresh_stats']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

function show_user_points($chat_id, $user_id) {
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    $user = $users_data['users'][$user_id] ?? null;
    
    if (!$user) {
        sendMessage($chat_id, "âŒ User data not found!");
        return;
    }
    
    $points = $user['points'] ?? 0;
    
    $message = "â­ <b>Your Points</b>\n\n";
    $message .= "ğŸ¯ Total Points: <b>$points</b>\n\n";
    
    $message .= "ğŸ“ˆ <b>How to earn points:</b>\n";
    $message .= "â€¢ ğŸ” Daily search: +1 point\n";
    $message .= "â€¢ ğŸ“¥ Movie download: +3 points\n";
    $message .= "â€¢ ğŸ“ Movie request: +2 points\n";
    $message .= "â€¢ ğŸ¯ Found movie: +5 points\n";
    $message .= "â€¢ ğŸ“… Daily login: +10 points\n\n";
    
    $message .= "ğŸ† <b>Your Rank:</b> " . calculate_user_rank($points) . "\n";
    $message .= "ğŸ“Š <b>Next Rank:</b> " . get_next_rank_info($points);
    
    sendMessage($chat_id, $message, null, 'HTML');
}

function show_leaderboard($chat_id) {
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    $users = $users_data['users'] ?? [];
    
    if (empty($users)) {
        sendMessage($chat_id, "ğŸ“­ Koi user data nahi mila!");
        return;
    }
    
    uasort($users, function($a, $b) {
        return ($b['points'] ?? 0) - ($a['points'] ?? 0);
    });
    
    $message = "ğŸ† <b>Top Users Leaderboard</b>\n\n";
    $i = 1;
    
    foreach (array_slice($users, 0, 10) as $user_id => $user) {
        $points = $user['points'] ?? 0;
        $username = $user['username'] ? "@" . $user['username'] : "User#" . substr($user_id, -4);
        $medal = $i == 1 ? "ğŸ¥‡" : ($i == 2 ? "ğŸ¥ˆ" : ($i == 3 ? "ğŸ¥‰" : "ğŸ”¸"));
        
        $message .= "$medal $i. $username\n";
        $message .= "   â­ $points points | ğŸ¯ " . calculate_user_rank($points) . "\n\n";
        $i++;
    }
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“Š My Stats', 'callback_data' => 'my_stats'],
                ['text' => 'ğŸ”„ Refresh', 'callback_data' => 'refresh_leaderboard']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

function calculate_user_rank($points) {
    if ($points >= 1000) return "ğŸ–ï¸ Elite";
    if ($points >= 500) return "ğŸ”¥ Pro";
    if ($points >= 250) return "â­ Advanced";
    if ($points >= 100) return "ğŸš€ Intermediate";
    if ($points >= 50) return "ğŸ‘ Beginner";
    return "ğŸŒ± Newbie";
}

function get_next_rank_info($points) {
    if ($points < 50) return "Beginner (50 points needed)";
    if ($points < 100) return "Intermediate (100 points needed)";
    if ($points < 250) return "Advanced (250 points needed)";
    if ($points < 500) return "Pro (500 points needed)";
    if ($points < 1000) return "Elite (1000 points needed)";
    return "Max Rank Achieved! ğŸ†";
}

// ==============================
// STEP 24: BROWSE COMMANDS
// ==============================
function show_latest_movies($chat_id, $limit = 10) {
    $all_movies = get_cached_movies();
    $latest_movies = array_slice($all_movies, -$limit);
    $latest_movies = array_reverse($latest_movies);
    
    if (empty($latest_movies)) {
        sendMessage($chat_id, "ğŸ“­ Koi movies nahi mili!");
        return;
    }
    
    $message = "ğŸ¬ <b>Latest $limit Movies</b>\n\n";
    $i = 1;
    
    foreach ($latest_movies as $movie) {
        $message .= "$i. <b>" . htmlspecialchars($movie['movie_name']) . "</b>\n";
        $message .= "   ğŸ“Š " . ($movie['quality'] ?? 'Unknown') . " | ğŸ—£ï¸ " . ($movie['language'] ?? 'Hindi') . "\n";
        $message .= "   ğŸ“… " . ($movie['date'] ?? 'N/A') . "\n\n";
        $i++;
    }
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“¥ Download All Latest', 'callback_data' => 'download_latest'],
                ['text' => 'ğŸ“Š Browse All', 'callback_data' => 'browse_all']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

function show_trending_movies($chat_id) {
    $all_movies = get_cached_movies();
    $trending_movies = array_slice($all_movies, -15);
    
    if (empty($trending_movies)) {
        sendMessage($chat_id, "ğŸ“­ Koi trending movies nahi mili!");
        return;
    }
    
    $message = "ğŸ”¥ <b>Trending Movies</b>\n\n";
    $i = 1;
    
    foreach (array_slice($trending_movies, 0, 10) as $movie) {
        $message .= "$i. <b>" . htmlspecialchars($movie['movie_name']) . "</b>\n";
        $message .= "   â­ " . ($movie['quality'] ?? 'HD') . " | ğŸ—£ï¸ " . ($movie['language'] ?? 'Hindi') . "\n\n";
        $i++;
    }
    
    $message .= "ğŸ’¡ <i>Based on recent popularity and downloads</i>";
    
    sendMessage($chat_id, $message, null, 'HTML');
}

function show_movies_by_quality($chat_id, $quality) {
    $all_movies = get_cached_movies();
    $filtered_movies = [];
    
    foreach ($all_movies as $movie) {
        if (stripos($movie['quality'] ?? '', $quality) !== false) {
            $filtered_movies[] = $movie;
        }
    }
    
    if (empty($filtered_movies)) {
        sendMessage($chat_id, "âŒ Koi $quality quality movies nahi mili!");
        return;
    }
    
    $message = "ğŸ¬ <b>$quality Quality Movies</b>\n\n";
    $message .= "ğŸ“Š Total Found: " . count($filtered_movies) . "\n\n";
    
    $i = 1;
    foreach (array_slice($filtered_movies, 0, 10) as $movie) {
        $message .= "$i. " . htmlspecialchars($movie['movie_name']) . "\n";
        $i++;
    }
    
    if (count($filtered_movies) > 10) {
        $message .= "\n... and " . (count($filtered_movies) - 10) . " more";
    }
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“¥ Download All', 'callback_data' => 'download_quality_' . $quality],
                ['text' => 'ğŸ”„ Other Qualities', 'callback_data' => 'show_qualities']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

function show_movies_by_language($chat_id, $language) {
    $all_movies = get_cached_movies();
    $filtered_movies = [];
    
    foreach ($all_movies as $movie) {
        if (stripos($movie['language'] ?? '', $language) !== false) {
            $filtered_movies[] = $movie;
        }
    }
    
    if (empty($filtered_movies)) {
        sendMessage($chat_id, "âŒ Koi $language movies nahi mili!");
        return;
    }
    
    $message = "ğŸ¬ <b>" . ucfirst($language) . " Movies</b>\n\n";
    $message .= "ğŸ“Š Total Found: " . count($filtered_movies) . "\n\n";
    
    $i = 1;
    foreach (array_slice($filtered_movies, 0, 10) as $movie) {
        $message .= "$i. " . htmlspecialchars($movie['movie_name']) . "\n";
        $message .= "   ğŸ“Š " . ($movie['quality'] ?? 'Unknown') . "\n\n";
        $i++;
    }
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“¥ Download All', 'callback_data' => 'download_lang_' . $language],
                ['text' => 'ğŸ”„ Other Languages', 'callback_data' => 'show_languages']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

// ==============================
// STEP 25: REQUEST MANAGEMENT
// ==============================
function show_user_requests($chat_id, $user_id) {
    $requests_data = json_decode(file_get_contents(REQUEST_FILE), true);
    $user_requests = [];
    
    foreach ($requests_data['requests'] ?? [] as $request) {
        if ($request['user_id'] == $user_id) {
            $user_requests[] = $request;
        }
    }
    
    if (empty($user_requests)) {
        sendMessage($chat_id, "ğŸ“­ Aapne abhi tak koi movie request nahi ki hai!");
        return;
    }
    
    $message = "ğŸ“ <b>Your Movie Requests</b>\n\n";
    $i = 1;
    
    foreach (array_slice($user_requests, 0, 10) as $request) {
        $status_emoji = $request['status'] == 'completed' ? 'âœ…' : 'â³';
        $message .= "$i. $status_emoji <b>" . htmlspecialchars($request['movie_name']) . "</b>\n";
        $message .= "   ğŸ“… " . $request['date'] . " | ğŸ—£ï¸ " . ucfirst($request['language']) . "\n";
        $message .= "   ğŸ†” " . $request['id'] . "\n\n";
        $i++;
    }
    
    $pending_count = count(array_filter($user_requests, function($req) {
        return $req['status'] == 'pending';
    }));
    
    $message .= "ğŸ“Š <b>Summary:</b>\n";
    $message .= "â€¢ Total Requests: " . count($user_requests) . "\n";
    $message .= "â€¢ Pending: $pending_count\n";
    $message .= "â€¢ Completed: " . (count($user_requests) - $pending_count);
    
    sendMessage($chat_id, $message, null, 'HTML');
}

function show_request_limit($chat_id, $user_id) {
    $requests_data = json_decode(file_get_contents(REQUEST_FILE), true);
    $today = date('Y-m-d');
    $today_requests = 0;
    
    foreach ($requests_data['requests'] ?? [] as $request) {
        if ($request['user_id'] == $user_id && $request['date'] == $today) {
            $today_requests++;
        }
    }
    
    $remaining = DAILY_REQUEST_LIMIT - $today_requests;
    
    $message = "ğŸ“‹ <b>Your Request Limit</b>\n\n";
    $message .= "âœ… Daily Limit: " . DAILY_REQUEST_LIMIT . " requests\n";
    $message .= "ğŸ“… Used Today: $today_requests requests\n";
    $message .= "ğŸ¯ Remaining Today: $remaining requests\n\n";
    
    if ($remaining > 0) {
        $message .= "ğŸ’¡ Use <code>/request movie_name</code> to request movies!";
    } else {
        $message .= "â³ Limit resets at midnight!";
    }
    
    sendMessage($chat_id, $message, null, 'HTML');
}

// ==============================
// STEP 26: ADMIN COMMANDS
// ==============================
function admin_stats($chat_id) {
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    $stats = get_stats();
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    $total_users = count($users_data['users'] ?? []);
    
    $msg = "ğŸ“Š <b>Bot Statistics</b>\n\n";
    $msg .= "ğŸ¬ Total Movies: " . ($stats['total_movies'] ?? 0) . "\n";
    $msg .= "ğŸ‘¥ Total Users: " . $total_users . "\n";
    $msg .= "ğŸ” Total Searches: " . ($stats['total_searches'] ?? 0) . "\n";
    $msg .= "âœ… Successful Searches: " . ($stats['successful_searches'] ?? 0) . "\n";
    $msg .= "âŒ Failed Searches: " . ($stats['failed_searches'] ?? 0) . "\n";
    $msg .= "ğŸ“¥ Total Downloads: " . ($stats['total_downloads'] ?? 0) . "\n";
    $msg .= "ğŸ•’ Last Updated: " . ($stats['last_updated'] ?? 'N/A') . "\n\n";
    
    $today = date('Y-m-d');
    if (isset($stats['daily_activity'][$today])) {
        $today_stats = $stats['daily_activity'][$today];
        $msg .= "ğŸ“ˆ <b>Today's Activity:</b>\n";
        $msg .= "â€¢ Searches: " . ($today_stats['searches'] ?? 0) . "\n";
        $msg .= "â€¢ Downloads: " . ($today_stats['downloads'] ?? 0) . "\n";
    }
    
    $csv_data = load_and_clean_csv();
    $recent = array_slice($csv_data, -5);
    $msg .= "\nğŸ“¦ Recent Uploads:\n";
    foreach ($recent as $r) {
        $msg .= "â€¢ " . $r['movie_name'] . " (" . $r['date'] . ")\n";
    }
    
    sendMessage($chat_id, $msg, null, 'HTML');
    bot_log("Admin stats viewed by $chat_id");
}

function show_csv_data($chat_id, $show_all = false) {
    if (!file_exists(CSV_FILE)) {
        sendMessage($chat_id, "âŒ CSV file not found.");
        return;
    }
    
    $handle = fopen(CSV_FILE, "r");
    if ($handle === FALSE) {
        sendMessage($chat_id, "âŒ Error opening CSV file.");
        return;
    }
    
    fgetcsv($handle);
    $movies = [];
    
    while (($row = fgetcsv($handle)) !== FALSE) {
        if (count($row) >= 3) {
            $movies[] = $row;
        }
    }
    fclose($handle);
    
    if (empty($movies)) {
        sendMessage($chat_id, "ğŸ“Š CSV file is empty.");
        return;
    }
    
    $movies = array_reverse($movies);
    $limit = $show_all ? count($movies) : 10;
    $movies = array_slice($movies, 0, $limit);
    
    $message = "ğŸ“Š <b>CSV Movie Database</b>\n\n";
    $message .= "ğŸ“ Total Movies: " . count($movies) . "\n";
    
    if (!$show_all) {
        $message .= "ğŸ” Showing latest 10 entries\n";
        $message .= "ğŸ“‹ Use '/checkcsv all' for full list\n\n";
    } else {
        $message .= "ğŸ“‹ Full database listing\n\n";
    }
    
    $i = 1;
    foreach ($movies as $movie) {
        $movie_name = $movie[0] ?? 'N/A';
        $message_id = $movie[1] ?? 'N/A';
        $date = $movie[2] ?? 'N/A';
        $quality = $movie[4] ?? 'Unknown';
        $language = $movie[6] ?? 'Hindi';
        
        $message .= "$i. ğŸ¬ " . htmlspecialchars($movie_name) . "\n";
        $message .= "   ğŸ“ ID: $message_id | ğŸ—£ï¸ $language | ğŸ“Š $quality\n";
        $message .= "   ğŸ“… Date: $date\n\n";
        
        $i++;
        
        if (strlen($message) > 3000) {
            sendMessage($chat_id, $message, null, 'HTML');
            $message = "ğŸ“Š Continuing...\n\n";
        }
    }
    
    $message .= "ğŸ’¾ File: " . CSV_FILE . "\n";
    $message .= "â° Last Updated: " . date('Y-m-d H:i:s', filemtime(CSV_FILE));
    
    sendMessage($chat_id, $message, null, 'HTML');
    bot_log("CSV data viewed by $chat_id - Show all: " . ($show_all ? 'Yes' : 'No'));
}

function send_broadcast($chat_id, $message) {
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    $total_users = count($users_data['users'] ?? []);
    $success_count = 0;
    
    $progress_msg = sendMessage($chat_id, "ğŸ“¢ Broadcasting to $total_users users...\n\nProgress: 0%");
    $progress_msg_id = $progress_msg['result']['message_id'];
    
    $i = 0;
    foreach ($users_data['users'] as $user_id => $user) {
        try {
            sendMessage($user_id, "ğŸ“¢ <b>Announcement from Admin:</b>\n\n$message", null, 'HTML');
            $success_count++;
            
            if ($i % 10 === 0) {
                $progress = round(($i / $total_users) * 100);
                editMessage($chat_id, $progress_msg_id, "ğŸ“¢ Broadcasting to $total_users users...\n\nProgress: $progress%");
            }
            
            usleep(100000);
            $i++;
        } catch (Exception $e) {
        }
    }
    
    editMessage($chat_id, $progress_msg_id, "âœ… Broadcast completed!\n\nğŸ“Š Sent to: $success_count/$total_users users");
    bot_log("Broadcast sent by $chat_id to $success_count users");
}

function toggle_maintenance_mode($chat_id, $mode) {
    global $MAINTENANCE_MODE;
    
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    if ($mode == 'on') {
        $MAINTENANCE_MODE = true;
        sendMessage($chat_id, "ğŸ”§ Maintenance mode ENABLED\n\nBot is now in maintenance mode. Users will see maintenance message.");
        bot_log("Maintenance mode enabled by $chat_id");
    } elseif ($mode == 'off') {
        $MAINTENANCE_MODE = false;
        sendMessage($chat_id, "âœ… Maintenance mode DISABLED\n\nBot is now operational.");
        bot_log("Maintenance mode disabled by $chat_id");
    } else {
        sendMessage($chat_id, "âŒ Usage: <code>/maintenance on</code> or <code>/maintenance off</code>", null, 'HTML');
    }
}

function perform_cleanup($chat_id) {
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    $stats_before = get_stats();
    
    $old = glob(BACKUP_DIR . '*', GLOB_ONLYDIR);
    if (count($old) > 7) {
        usort($old, function($a, $b) {
            return filemtime($a) - filemtime($b);
        });
        
        $deleted_count = 0;
        foreach (array_slice($old, 0, count($old) - 7) as $d) {
            $files = glob($d . '/*');
            foreach ($files as $ff) @unlink($ff);
            if (@rmdir($d)) $deleted_count++;
        }
    }
    
    global $movie_cache;
    $movie_cache = [];
    
    sendMessage($chat_id, "ğŸ§¹ Cleanup completed!\n\nâ€¢ Old backups removed\nâ€¢ Cache cleared\nâ€¢ System optimized");
    bot_log("Cleanup performed by $chat_id");
}

function send_alert_to_all($chat_id, $alert_message) {
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    $success_count = 0;
    
    foreach ($users_data['users'] as $user_id => $user) {
        try {
            sendMessage($user_id, "ğŸš¨ <b>Important Alert:</b>\n\n$alert_message", null, 'HTML');
            $success_count++;
            usleep(50000);
        } catch (Exception $e) {
        }
    }
    
    sendMessage($chat_id, "âœ… Alert sent to $success_count users!");
    bot_log("Alert sent by $chat_id: " . substr($alert_message, 0, 50));
}

// ==============================
// STEP 27: UTILITY FUNCTIONS
// ==============================
function check_date($chat_id) {
    if (!file_exists(CSV_FILE)) {
        sendMessage($chat_id, "âš ï¸ Abhi tak koi data save nahi hua.");
        return;
    }
    
    $date_counts = [];
    $h = fopen(CSV_FILE, 'r');
    
    if ($h !== FALSE) {
        fgetcsv($h);
        while (($r = fgetcsv($h)) !== FALSE) {
            if (count($r) >= 3) {
                $d = $r[2];
                if (!isset($date_counts[$d])) $date_counts[$d] = 0;
                $date_counts[$d]++;
            }
        }
        fclose($h);
    }
    
    krsort($date_counts);
    $msg = "ğŸ“… <b>Movies Upload Record</b>\n\n";
    $total_days = 0;
    $total_movies = 0;
    
    foreach ($date_counts as $date => $count) {
        $msg .= "â¡ï¸ $date: $count movies\n";
        $total_days++;
        $total_movies += $count;
    }
    
    $msg .= "\nğŸ“Š <b>Summary:</b>\n";
    $msg .= "â€¢ Total Days: $total_days\n";
    $msg .= "â€¢ Total Movies: $total_movies\n";
    $msg .= "â€¢ Average per day: " . round($total_movies / max(1, $total_days), 2);
    
    sendMessage($chat_id, $msg, null, 'HTML');
}

function test_csv($chat_id) {
    if (!file_exists(CSV_FILE)) {
        sendMessage($chat_id, "âš ï¸ CSV file not found.");
        return;
    }
    
    $h = fopen(CSV_FILE, 'r');
    if ($h !== FALSE) {
        fgetcsv($h);
        $i = 1;
        $msg = "";
        
        while (($r = fgetcsv($h)) !== FALSE) {
            if (count($r) >= 3) {
                $line = "$i. {$r[0]} | ID/Ref: {$r[1]} | Date: {$r[2]}";
                if (isset($r[4])) $line .= " | Quality: {$r[4]}";
                if (isset($r[6])) $line .= " | Language: {$r[6]}";
                $line .= "\n";
                
                if (strlen($msg) + strlen($line) > 4000) {
                    sendMessage($chat_id, $msg);
                    $msg = "";
                }
                $msg .= $line;
                $i++;
            }
        }
        fclose($h);
        
        if (!empty($msg)) {
            sendMessage($chat_id, $msg);
        }
    }
}

function show_bot_info($chat_id) {
    $stats = get_stats();
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    
    $message = "ğŸ¤– <b>Entertainment Tadka Bot</b>\n\n";
    $message .= "ğŸ“± <b>Version:</b> 2.1.0\n";
    $message .= "ğŸ†™ <b>Last Updated:</b> " . date('Y-m-d') . "\n";
    $message .= "ğŸ‘¨â€ğŸ’» <b>Developer:</b> @EntertainmentTadka0786\n\n";
    
    $message .= "ğŸ“Š <b>Bot Statistics:</b>\n";
    $message .= "â€¢ ğŸ¬ Movies: " . ($stats['total_movies'] ?? 0) . "\n";
    $message .= "â€¢ ğŸ‘¥ Users: " . count($users_data['users'] ?? []) . "\n";
    $message .= "â€¢ ğŸ” Searches: " . ($stats['total_searches'] ?? 0) . "\n";
    $message .= "â€¢ ğŸ“¥ Downloads: " . ($stats['total_downloads'] ?? 0) . "\n\n";
    
    $message .= "ğŸ¯ <b>Features:</b>\n";
    $message .= "â€¢ Smart movie search\n";
    $message .= "â€¢ Multi-language support\n";
    $message .= "â€¢ Quality filtering\n";
    $message .= "â€¢ Movie requests\n";
    $message .= "â€¢ User points system\n";
    $message .= "â€¢ Leaderboard\n";
    $message .= "â€¢ Auto-notification to request group\n\n";
    
    $message .= "ğŸ“¢ <b>Channels:</b>\n";
    $message .= "â€¢ Main: " . MAIN_CHANNEL . "\n";
    $message .= "â€¢ Support: " . REQUEST_CHANNEL . "\n";
    $message .= "â€¢ Theater Print: " . THEATER_PRINT_CHANNEL . "\n";
    $message .= "â€¢ Backup: " . BACKUP_CHANNEL_USERNAME;
    
    sendMessage($chat_id, $message, null, 'HTML');
}

function show_support_info($chat_id) {
    $message = "ğŸ†˜ <b>Support & Contact</b>\n\n";
    
    $message .= "ğŸ“ <b>Need Help?</b>\n";
    $message .= "â€¢ Movie not found?\n";
    $message .= "â€¢ Technical issues?\n";
    $message .= "â€¢ Feature requests?\n\n";
    
    $message .= "ğŸ¯ <b>Quick Solutions:</b>\n";
    $message .= "1. Use <code>/request movie_name</code> for new movies\n";
    $message .= "2. Check <code>/help</code> for all commands\n";
    $message .= "3. Join support channel below\n\n";
    
    $message .= "ğŸ“¢ <b>Support Channel:</b> " . REQUEST_CHANNEL . "\n";
    $message .= "ğŸ‘¨â€ğŸ’» <b>Admin:</b> @EntertainmentTadka0786\n\n";
    
    $message .= "ğŸ’¡ <b>Pro Tip:</b> Always check spelling before reporting!";
    
    $keyboard = [
        'inline_keyboard' => [
            [
                ['text' => 'ğŸ“¢ Support Channel', 'url' => 'https://t.me/EntertainmentTadka0786'],
                ['text' => 'ğŸ› Report Bug', 'callback_data' => 'report_bug']
            ],
            [
                ['text' => 'ğŸ’¡ Suggest Feature', 'callback_data' => 'suggest_feature'],
                ['text' => 'ğŸ“ Give Feedback', 'callback_data' => 'give_feedback']
            ]
        ]
    ];
    
    sendMessage($chat_id, $message, $keyboard, 'HTML');
}

function show_donate_info($chat_id) {
    $message = "ğŸ’ <b>Support Our Work</b>\n\n";
    
    $message .= "ğŸ¤– <b>Why Donate?</b>\n";
    $message .= "â€¢ Server maintenance costs\n";
    $message .= "â€¢ Bot development & updates\n";
    $message .= "â€¢ New features implementation\n";
    $message .= "â€¢ 24/7 service availability\n\n";
    
    $message .= "ğŸ’° <b>Donation Methods:</b>\n";
    $message .= "â€¢ UPI: entertainmenttadka@upi\n";
    $message .= "â€¢ PayPal: coming soon\n";
    $message .= "â€¢ Crypto: coming soon\n\n";
    
    $message .= "ğŸ <b>Donor Benefits:</b>\n";
    $message .= "â€¢ Priority support\n";
    $message .= "â€¢ Early access to features\n";
    $message .= "â€¢ Special donor badge\n";
    $message .= "â€¢ Increased request limits\n\n";
    
    $message .= "ğŸ’Œ <b>Contact for other methods:</b> " . REQUEST_CHANNEL;
    
    sendMessage($chat_id, $message, null, 'HTML');
}

function submit_bug_report($chat_id, $user_id, $bug_report) {
    $report_id = uniqid();
    
    $admin_message = "ğŸ› <b>New Bug Report</b>\n\n";
    $admin_message .= "ğŸ†” Report ID: $report_id\n";
    $admin_message .= "ğŸ‘¤ User ID: $user_id\n";
    $admin_message .= "ğŸ“… Time: " . date('Y-m-d H:i:s') . "\n\n";
    $admin_message .= "ğŸ“ <b>Bug Description:</b>\n$bug_report";
    
    sendMessage(ADMIN_ID, $admin_message, null, 'HTML');
    sendMessage($chat_id, "âœ… Bug report submitted!\n\nğŸ†” Report ID: <code>$report_id</code>\n\nWe'll fix it soon! ğŸ› ï¸", null, 'HTML');
    
    bot_log("Bug report submitted by $user_id: $report_id");
}

function submit_feedback($chat_id, $user_id, $feedback) {
    $feedback_id = uniqid();
    
    $admin_message = "ğŸ’¡ <b>New User Feedback</b>\n\n";
    $admin_message .= "ğŸ†” Feedback ID: $feedback_id\n";
    $admin_message .= "ğŸ‘¤ User ID: $user_id\n";
    $admin_message .= "ğŸ“… Time: " . date('Y-m-d H:i:s') . "\n\n";
    $admin_message .= "ğŸ“ <b>Feedback:</b>\n$feedback";
    
    sendMessage(ADMIN_ID, $admin_message, null, 'HTML');
    sendMessage($chat_id, "âœ… Feedback submitted!\n\nğŸ†” Feedback ID: <code>$feedback_id</code>\n\nThanks for your input! ğŸŒŸ", null, 'HTML');
    
    bot_log("Feedback submitted by $user_id: $feedback_id");
}

function show_version_info($chat_id) {
    $message = "ğŸ”„ <b>Bot Version Information</b>\n\n";
    
    $message .= "ğŸ“± <b>Current Version:</b> v2.1.0\n";
    $message .= "ğŸ†™ <b>Release Date:</b> " . date('Y-m-d') . "\n";
    $message .= "ğŸ› <b>Status:</b> Stable Release\n\n";
    
    $message .= "ğŸ¯ <b>What's New in v2.1.0:</b>\n";
    $message .= "â€¢ Auto-notification to request group\n";
    $message .= "â€¢ Theater Print channel integration\n";
    $message .= "â€¢ Enhanced movie delivery system\n";
    $message .= "â€¢ Bug fixes & improvements\n\n";
    
    $message .= "ğŸ“‹ <b>Upcoming Features:</b>\n";
    $message .= "â€¢ Movie ratings & reviews\n";
    $message .= "â€¢ Watchlist feature\n";
    $message .= "â€¢ Advanced filters\n";
    $message .= "â€¢ User profiles\n";
    $message .= "â€¢ More coming soon...\n\n";
    
    $message .= "ğŸ› <b>Found a bug?</b> Use <code>/report</code>\n";
    $message .= "ğŸ’¡ <b>Suggestions?</b> Use <code>/feedback</code>";
    
    sendMessage($chat_id, $message, null, 'HTML');
}

// ==============================
// STEP 28: GROUP MESSAGE FILTER
// ==============================
function is_valid_movie_query($text) {
    $text = strtolower(trim($text));
    
    if (strpos($text, '/') === 0) {
        return true;
    }
    
    if (strlen($text) < 3) {
        return false;
    }
    
    $invalid_phrases = [
        'good morning', 'good night', 'hello', 'hi ', 'hey ', 'thank you', 'thanks',
        'welcome', 'bye', 'see you', 'ok ', 'okay', 'yes', 'no', 'maybe',
        'how are you', 'whats up', 'anyone', 'someone', 'everyone',
        'problem', 'issue', 'help', 'question', 'doubt', 'query'
    ];
    
    foreach ($invalid_phrases as $phrase) {
        if (strpos($text, $phrase) !== false) {
            return false;
        }
    }
    
    $movie_patterns = [
        'movie', 'film', 'video', 'download', 'watch', 'hd', 'full', 'part',
        'series', 'episode', 'season', 'bollywood', 'hollywood'
    ];
    
    foreach ($movie_patterns as $pattern) {
        if (strpos($text, $pattern) !== false) {
            return true;
        }
    }
    
    if (preg_match('/^[a-zA-Z0-9\s\-\.\,]{3,}$/', $text)) {
        return true;
    }
    
    return false;
}

// ==============================
// STEP 29: COMPLETE COMMAND HANDLER
// ==============================
function handle_command($chat_id, $user_id, $command, $params = []) {
    switch ($command) {
        case '/start':
            $welcome = "ğŸ¬ <b>Welcome to Entertainment Tadka!</b>\n\n";
            $welcome .= "ğŸ“¢ <b>How to use this bot:</b>\n";
            $welcome .= "â€¢ Simply type any movie name\n";
            $welcome .= "â€¢ Use English or Hindi\n";
            $welcome .= "â€¢ Partial names also work\n\n";
            $welcome .= "ğŸ” <b>Examples:</b>\n";
            $welcome .= "â€¢ kgf\nâ€¢ pushpa\nâ€¢ avengers\nâ€¢ hindi movie\nâ€¢ spider-man\n\n";
            $welcome .= "âŒ <b>Don't type:</b>\n";
            $welcome .= "â€¢ Technical questions\n";
            $welcome .= "â€¢ Player instructions\n";
            $welcome .= "â€¢ Non-movie queries\n\n";
            $welcome .= "ğŸ“¢ <b>Join Our Channels:</b>\n";
            $welcome .= "ğŸ¿ Main: " . MAIN_CHANNEL . "\n";
            $welcome .= "ğŸ“¥ Requests: " . REQUEST_CHANNEL . "\n";
            $welcome .= "ğŸ­ Theater Prints: " . THEATER_PRINT_CHANNEL . "\n";
            $welcome .= "ğŸ”’ Backup: " . BACKUP_CHANNEL_USERNAME . "\n\n";
            $welcome .= "ğŸ”” <b>New Feature:</b> Request group gets auto-notification when movies are uploaded!\n\n";
            $welcome .= "ğŸ’¬ <b>Need help?</b> Use /help for all commands";
        
            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ” Search Movies', 'switch_inline_query_current_chat' => ''],
                        ['text' => 'ğŸ¿ Main Channel', 'url' => 'https://t.me/EntertainmentTadka786']
                    ],
                    [
                        ['text' => 'ğŸ“¥ Requests', 'url' => 'https://t.me/EntertainmentTadka7860'],
                        ['text' => 'ğŸ“Š My Stats', 'callback_data' => 'my_stats']
                    ],
                    [
                        ['text' => 'ğŸ­ Theater Prints', 'url' => 'https://t.me/threater_print_movies'],
                        ['text' => 'ğŸ”’ Backup', 'url' => 'https://t.me/ETBackup']
                    ],
                    [
                        ['text' => 'â“ Help', 'callback_data' => 'help_command']
                    ]
                ]
            ];
            
            sendMessage($chat_id, $welcome, $keyboard, 'HTML');
            update_user_activity($user_id, 'daily_login');
            break;

        case '/help':
        case '/commands':
            $help = "ğŸ¤– <b>Entertainment Tadka Bot - Complete Guide</b>\n\n";
            
            $help .= "ğŸ“¢ <b>Our Channels:</b>\n";
            $help .= "ğŸ¿ Main: " . MAIN_CHANNEL . " - Latest movies\n";
            $help .= "ğŸ“¥ Requests: " . REQUEST_CHANNEL . " - Support & requests\n";
            $help .= "ğŸ­ Theater Prints: " . THEATER_PRINT_CHANNEL . " - Quality prints\n";
            $help .= "ğŸ”’ Backup: " . BACKUP_CHANNEL_USERNAME . " - Data protection\n\n";
            
            $help .= "ğŸ¯ <b>Search Commands:</b>\n";
            $help .= "â€¢ Just type movie name - Smart search\n";
            $help .= "â€¢ <code>/search movie</code> - Direct search\n";
            $help .= "â€¢ <code>/s movie</code> - Quick search\n\n";
            
            $help .= "ğŸ“ <b>Browse Commands:</b>\n";
            $help .= "â€¢ <code>/browse</code> - Enhanced pagination\n";
            $help .= "â€¢ <code>/totalupload</code> - All movies\n";
            $help .= "â€¢ <code>/latest</code> - New additions\n";
            $help .= "â€¢ <code>/trending</code> - Popular movies\n\n";
            
            $help .= "ğŸ“ <b>Request Commands:</b>\n";
            $help .= "â€¢ <code>/request movie</code> - Request movie\n";
            $help .= "â€¢ <code>/myrequests</code> - Request status\n";
            $help .= "â€¢ Join " . REQUEST_CHANNEL . " for support\n\n";
            
            $help .= "ğŸ‘¤ <b>User Commands:</b>\n";
            $help .= "â€¢ <code>/mystats</code> - Your statistics\n";
            $help .= "â€¢ <code>/leaderboard</code> - Top users\n";
            $help .= "â€¢ <code>/mypoints</code> - Points info\n\n";
            
            $help .= "ğŸ”— <b>Channel Commands:</b>\n";
            $help .= "â€¢ <code>/channel</code> - All channels\n";
            $help .= "â€¢ <code>/mainchannel</code> - Main channel\n";
            $help .= "â€¢ <code>/requestchannel</code> - Requests\n";
            $help .= "â€¢ <code>/theaterprints</code> - Theater prints\n";
            $help .= "â€¢ <code>/backupchannel</code> - Backup info\n\n";
            
            $help .= "ğŸ”” <b>Auto-Notification:</b>\n";
            $help .= "Request group gets notified automatically when new movies are uploaded!\n\n";
            
            $help .= "ğŸ’¡ <b>Pro Tips:</b>\n";
            $help .= "â€¢ Use partial names (e.g., 'aveng')\n";
            $help .= "â€¢ Join all channels for updates\n";
            $help .= "â€¢ Request movies you can't find\n";
            $help .= "â€¢ Check spelling before reporting";

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ¿ ' . MAIN_CHANNEL, 'url' => 'https://t.me/EntertainmentTadka786'],
                        ['text' => 'ğŸ“¥ ' . REQUEST_CHANNEL, 'url' => 'https://t.me/EntertainmentTadka7860']
                    ],
                    [
                        ['text' => 'ğŸ­ ' . THEATER_PRINT_CHANNEL, 'url' => 'https://t.me/threater_print_movies'],
                        ['text' => 'ğŸ”’ ' . BACKUP_CHANNEL_USERNAME, 'url' => 'https://t.me/ETBackup']
                    ],
                    [
                        ['text' => 'ğŸ¬ Search Movies', 'switch_inline_query_current_chat' => '']
                    ]
                ]
            ];
            
            sendMessage($chat_id, $help, $keyboard, 'HTML');
            break;

        case '/search':
        case '/s':
        case '/find':
            $movie_name = implode(' ', $params);
            if (empty($movie_name)) {
                sendMessage($chat_id, "âŒ Usage: <code>/search movie_name</code>\nExample: <code>/search kgf 2</code>", null, 'HTML');
                return;
            }
            $lang = detect_language($movie_name);
            send_multilingual_response($chat_id, 'searching', $lang);
            advanced_search($chat_id, $movie_name, $user_id);
            break;

        case '/totalupload':
        case '/browse':
            $page = isset($params[0]) ? intval($params[0]) : 1;
            enhanced_pagination_controller($chat_id, $page);
            break;

        case '/latest':
        case '/recent':
        case '/new':
            show_latest_movies($chat_id, isset($params[0]) ? intval($params[0]) : 10);
            break;

        case '/trending':
        case '/popular':
            show_trending_movies($chat_id);
            break;

        case '/quality':
            $quality = isset($params[0]) ? $params[0] : '1080p';
            show_movies_by_quality($chat_id, $quality);
            break;

        case '/language':
            $language = isset($params[0]) ? $params[0] : 'hindi';
            show_movies_by_language($chat_id, $language);
            break;

        case '/request':
        case '/req':
        case '/requestmovie':
            $movie_name = implode(' ', $params);
            if (empty($movie_name)) {
                sendMessage($chat_id, "âŒ Usage: <code>/request movie_name</code>\nExample: <code>/request Animal Park</code>", null, 'HTML');
                return;
            }
            $lang = detect_language($movie_name);
            if (add_movie_request($user_id, $movie_name, $lang)) {
                send_multilingual_response($chat_id, 'request_success', $lang);
                update_user_activity($user_id, 'movie_request');
            } else {
                send_multilingual_response($chat_id, 'request_limit', $lang);
            }
            break;

        case '/myrequests':
        case '/myreqs':
            show_user_requests($chat_id, $user_id);
            break;

        case '/requestlimit':
        case '/reqlimit':
            show_request_limit($chat_id, $user_id);
            break;

        case '/mystats':
        case '/mystatistics':
        case '/profile':
            show_user_stats($chat_id, $user_id);
            break;

        case '/mypoints':
        case '/points':
            show_user_points($chat_id, $user_id);
            break;

        case '/leaderboard':
        case '/topusers':
        case '/ranking':
            show_leaderboard($chat_id);
            break;

        case '/channel':
        case '/channels':
        case '/join':
            show_channel_info($chat_id);
            break;

        case '/mainchannel':
        case '/entertainmenttadka':
            show_main_channel_info($chat_id);
            break;

        case '/requestchannel':
        case '/requests':
        case '/support':
            show_request_channel_info($chat_id);
            break;

        case '/theaterprints':
        case '/theater':
        case '/prints':
            show_theater_print_channel_info($chat_id);
            break;

        case '/backupchannel':
        case '/etbackup':
            show_backup_channel_info($chat_id);
            break;

        case '/checkdate':
        case '/datestats':
        case '/uploadstats':
            check_date($chat_id);
            break;

        case '/stats':
        case '/statistics':
        case '/botstats':
            if ($user_id == ADMIN_ID) {
                admin_stats($chat_id);
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        case '/checkcsv':
        case '/csvdata':
        case '/database':
            $show_all = (isset($params[0]) && strtolower($params[0]) == 'all');
            show_csv_data($chat_id, $show_all);
            break;

        case '/testcsv':
        case '/rawdata':
        case '/export':
            test_csv($chat_id);
            break;

        case '/info':
        case '/about':
        case '/botinfo':
            show_bot_info($chat_id);
            break;

        case '/support':
        case '/contact':
        case '/helpgroup':
            show_support_info($chat_id);
            break;

        case '/version':
        case '/changelog':
            show_version_info($chat_id);
            break;

        case '/broadcast':
            if ($user_id == ADMIN_ID) {
                $message = implode(' ', $params);
                if (empty($message)) {
                    sendMessage($chat_id, "âŒ Usage: <code>/broadcast your_message</code>", null, 'HTML');
                    return;
                }
                send_broadcast($chat_id, $message);
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        case '/backup':
            if ($user_id == ADMIN_ID) {
                manual_backup($chat_id);
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        case '/quickbackup':
        case '/qbackup':
            if ($user_id == ADMIN_ID) {
                quick_backup($chat_id);
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        case '/backupstatus':
        case '/backupinfo':
            if ($user_id == ADMIN_ID) {
                backup_status($chat_id);
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        case '/maintenance':
            if ($user_id == ADMIN_ID) {
                $mode = isset($params[0]) ? strtolower($params[0]) : '';
                toggle_maintenance_mode($chat_id, $mode);
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        case '/cleanup':
            if ($user_id == ADMIN_ID) {
                perform_cleanup($chat_id);
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        case '/sendalert':
            if ($user_id == ADMIN_ID) {
                $alert_message = implode(' ', $params);
                if (empty($alert_message)) {
                    sendMessage($chat_id, "âŒ Usage: <code>/sendalert your_alert</code>", null, 'HTML');
                    return;
                }
                send_alert_to_all($chat_id, $alert_message);
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        case '/ping':
        case '/status':
            sendMessage($chat_id, "ğŸ“ <b>Bot Status:</b> âœ… Online\nâ° <b>Server Time:</b> " . date('Y-m-d H:i:s'), null, 'HTML');
            break;

        case '/donate':
        case '/supportus':
            show_donate_info($chat_id);
            break;

        case '/report':
        case '/reportbug':
            $bug_report = implode(' ', $params);
            if (empty($bug_report)) {
                sendMessage($chat_id, "âŒ Usage: <code>/report bug_description</code>", null, 'HTML');
                return;
            }
            submit_bug_report($chat_id, $user_id, $bug_report);
            break;

        case '/feedback':
            $feedback = implode(' ', $params);
            if (empty($feedback)) {
                sendMessage($chat_id, "âŒ Usage: <code>/feedback your_feedback</code>", null, 'HTML');
                return;
            }
            submit_feedback($chat_id, $user_id, $feedback);
            break;

        case '/test':
            if ($user_id == ADMIN_ID) {
                $test_type = isset($params[0]) ? strtolower($params[0]) : 'basic';
                $valid_types = ['basic', 'full', 'channel', 'backup', 'database', 'notification'];
                
                if (in_array($test_type, $valid_types)) {
                    send_test_notification($chat_id, $test_type);
                } else {
                    sendMessage($chat_id, 
                        "âŒ Invalid test type. Available types:\n\n" .
                        "â€¢ <code>/test basic</code> - Basic system check\n" .
                        "â€¢ <code>/test full</code> - Full diagnostics\n" .
                        "â€¢ <code>/test channel</code> - Channel connectivity\n" .
                        "â€¢ <code>/test backup</code> - Backup system test\n" .
                        "â€¢ <code>/test database</code> - Database integrity\n" .
                        "â€¢ <code>/test notification</code> - Auto-notification test\n",
                        null, 'HTML'
                    );
                }
            } else {
                sendMessage($chat_id, "âŒ Access denied. Admin only command.");
            }
            break;

        default:
            sendMessage($chat_id, "âŒ Unknown command. Use <code>/help</code> to see all available commands.", null, 'HTML');
    }
}

// ==============================
// STEP 30: MAIN UPDATE PROCESSING
// ==============================
$update = json_decode(file_get_contents('php://input'), true);

if ($update) {
    global $MAINTENANCE_MODE, $MAINTENANCE_MESSAGE;
    if ($MAINTENANCE_MODE && isset($update['message'])) {
        $chat_id = $update['message']['chat']['id'];
        sendMessage($chat_id, $MAINTENANCE_MESSAGE, null, 'HTML');
        bot_log("Maintenance mode active - message blocked from $chat_id");
        exit;
    }

    get_cached_movies();

    if (isset($update['channel_post'])) {
        $message = $update['channel_post'];
        $message_id = $message['message_id'];
        $chat_id = $message['chat']['id'];

        if ($chat_id == CHANNEL_ID) {
            $text = '';
            $quality = 'Unknown';
            $size = 'Unknown';
            $language = 'Hindi';

            if (isset($message['caption'])) {
                $text = $message['caption'];
                if (stripos($text, '1080') !== false) $quality = '1080p';
                elseif (stripos($text, '720') !== false) $quality = '720p';
                elseif (stripos($text, '480') !== false) $quality = '480p';
                
                if (stripos($text, 'english') !== false) $language = 'English';
                if (stripos($text, 'hindi') !== false) $language = 'Hindi';
            }
            elseif (isset($message['text'])) {
                $text = $message['text'];
            }
            elseif (isset($message['document'])) {
                $text = $message['document']['file_name'];
                $size = round($message['document']['file_size'] / (1024 * 1024), 2) . ' MB';
            }
            else {
                $text = 'Uploaded Media - ' . date('d-m-Y H:i');
            }

            if (!empty(trim($text))) {
                append_movie($text, $message_id, date('d-m-Y'), '', $quality, $size, $language);
                bot_log("New movie captured from PRIVATE CHANNEL: $text");
            }
        }
    }

    if (isset($update['message'])) {
        $message = $update['message'];
        $chat_id = $message['chat']['id'];
        $user_id = $message['from']['id'];
        $text = isset($message['text']) ? $message['text'] : '';
        $chat_type = $message['chat']['type'] ?? 'private';

        $user_info = [
            'first_name' => $message['from']['first_name'] ?? '',
            'last_name' => $message['from']['last_name'] ?? '',
            'username' => $message['from']['username'] ?? ''
        ];
        update_user_data($user_id, $user_info);

        if ($chat_type !== 'private') {
            if (strpos($text, '/') === 0) {
            } else {
                if (!is_valid_movie_query($text)) {
                    bot_log("Invalid group message blocked from $chat_id: $text");
                    return;
                }
            }
        }

        if (strpos($text, '/') === 0) {
            $parts = explode(' ', $text);
            $command = strtolower($parts[0]);
            $params = array_slice($parts, 1);
            
            handle_command($chat_id, $user_id, $command, $params);
        } else if (!empty(trim($text))) {
            $lang = detect_language($text);
            send_multilingual_response($chat_id, 'searching', $lang);
            advanced_search($chat_id, $text, $user_id);
        }
    }

    if (isset($update['callback_query'])) {
        $query = $update['callback_query'];
        $message = $query['message'];
        $chat_id = $message['chat']['id'];
        $user_id = $query['from']['id'];
        $data = $query['data'];

        global $movie_messages;
        
        $movie_lower = strtolower($data);
        if (isset($movie_messages[$movie_lower])) {
            $entries = $movie_messages[$movie_lower];
            $cnt = 0;
            
            foreach ($entries as $entry) {
                // Silent delivery using COPY priority
                deliver_item_to_chat($chat_id, $entry);
                usleep(150000);
                $cnt++;
            }
            
            // Minimal confirmation
            answerCallbackQuery($query['id'], "âœ… " . $cnt . " movies sent");
            update_user_activity($user_id, 'download');
        }
        elseif (strpos($data, 'pag_') === 0) {
            $parts = explode('_', $data);
            $action = $parts[1];
            $session_id = isset($parts[2]) ? $parts[2] : '';
            
            if ($action == 'first') {
                enhanced_pagination_controller($chat_id, 1, [], $session_id);
                answerCallbackQuery($query['id'], "First page");
            } 
            elseif ($action == 'last') {
                $all = get_cached_movies();
                $total_pages = ceil(count($all) / ITEMS_PER_PAGE);
                enhanced_pagination_controller($chat_id, $total_pages, [], $session_id);
                answerCallbackQuery($query['id'], "Last page");
            }
            elseif ($action == 'prev') {
                $current_page = isset($parts[2]) ? intval($parts[2]) : 1;
                $session_id = isset($parts[3]) ? $parts[3] : '';
                enhanced_pagination_controller($chat_id, max(1, $current_page - 1), [], $session_id);
                answerCallbackQuery($query['id'], "Previous page");
            }
            elseif ($action == 'next') {
                $current_page = isset($parts[2]) ? intval($parts[2]) : 1;
                $session_id = isset($parts[3]) ? $parts[3] : '';
                $all = get_cached_movies();
                $total_pages = ceil(count($all) / ITEMS_PER_PAGE);
                enhanced_pagination_controller($chat_id, min($total_pages, $current_page + 1), [], $session_id);
                answerCallbackQuery($query['id'], "Next page");
            }
            elseif (is_numeric($action)) {
                $page_num = intval($action);
                $session_id = isset($parts[2]) ? $parts[2] : '';
                enhanced_pagination_controller($chat_id, $page_num, [], $session_id);
                answerCallbackQuery($query['id'], "Page $page_num");
            }
        }
        elseif (strpos($data, 'vidprev_') === 0) {
            $parts = explode('_', $data);
            $page_num = isset($parts[1]) ? intval($parts[1]) : 1;
            $session_id = isset($parts[2]) ? $parts[2] : '';
            
            send_video_preview($chat_id, $page_num, $session_id);
            answerCallbackQuery($query['id'], "ğŸ¬ Sending video previews...");
        }
        elseif (strpos($data, 'txtprev_') === 0) {
            $parts = explode('_', $data);
            $page_num = isset($parts[1]) ? intval($parts[1]) : 1;
            $session_id = isset($parts[2]) ? $parts[2] : '';
            
            send_text_preview($chat_id, $page_num, $session_id);
            answerCallbackQuery($query['id'], "ğŸ‘ï¸ Sending text preview...");
        }
        elseif (strpos($data, 'send_') === 0) {
            $parts = explode('_', $data);
            $page_num = isset($parts[1]) ? intval($parts[1]) : 1;
            $session_id = isset($parts[2]) ? $parts[2] : '';
            
            $all = get_cached_movies();
            $pg = paginate_movies($all, $page_num, []);
            batch_download_with_progress($chat_id, $pg['slice'], $page_num);
            answerCallbackQuery($query['id'], "ğŸ“¦ Batch download started!");
        }
        elseif (strpos($data, 'flt_') === 0) {
            $parts = explode('_', $data);
            $filter_type = $parts[1];
            $session_id = isset($parts[2]) ? $parts[2] : '';
            
            $filters = [];
            if ($filter_type == 'hd') {
                $filters = ['quality' => '1080'];
                answerCallbackQuery($query['id'], "HD filter applied");
            } elseif ($filter_type == 'new') {
                answerCallbackQuery($query['id'], "Latest filter applied");
            } elseif ($filter_type == 'pop') {
                answerCallbackQuery($query['id'], "Popular filter applied");
            } elseif ($filter_type == 'clr') {
                answerCallbackQuery($query['id'], "Filters cleared");
            }
            
            enhanced_pagination_controller($chat_id, 1, $filters, $session_id);
        }
        elseif ($data == 'close_' || strpos($data, 'close_') === 0) {
            deleteMessage($chat_id, $message['message_id']);
            sendMessage($chat_id, "ğŸ—‚ï¸ Pagination closed. Use /browse to start again.");
            answerCallbackQuery($query['id'], "Pagination closed");
        }
        elseif (strpos($data, 'auto_request_') === 0) {
            $movie_name = base64_decode(str_replace('auto_request_', '', $data));
            $lang = detect_language($movie_name);
            
            if (add_movie_request($user_id, $movie_name, $lang)) {
                send_multilingual_response($chat_id, 'request_success', $lang);
                answerCallbackQuery($query['id'], "Request sent successfully!");
                update_user_activity($user_id, 'movie_request');
            } else {
                send_multilingual_response($chat_id, 'request_limit', $lang);
                answerCallbackQuery($query['id'], "Daily limit reached!", true);
            }
        }
        elseif ($data === 'request_movie') {
            sendMessage($chat_id, "ğŸ“ To request a movie, use:\n<code>/request movie_name</code>\n\nExample: <code>/request Avengers Endgame</code>", null, 'HTML');
            answerCallbackQuery($query['id'], "Request instructions sent");
        }
        elseif ($data === 'my_stats') {
            show_user_stats($chat_id, $user_id);
            answerCallbackQuery($query['id'], "Your statistics");
        }
        elseif ($data === 'show_leaderboard') {
            show_leaderboard($chat_id);
            answerCallbackQuery($query['id'], "Leaderboard");
        }
        elseif ($data === 'backup_status') {
            if ($chat_id == ADMIN_ID) {
                backup_status($chat_id);
                answerCallbackQuery($query['id'], "Backup status");
            } else {
                answerCallbackQuery($query['id'], "Admin only command!", true);
            }
        }
        elseif ($data === 'run_backup') {
            if ($chat_id == ADMIN_ID) {
                manual_backup($chat_id);
                answerCallbackQuery($query['id'], "Backup started");
            } else {
                answerCallbackQuery($query['id'], "Admin only command!", true);
            }
        }
        elseif ($data === 'help_command') {
            $command = '/help';
            $params = [];
            handle_command($chat_id, $user_id, $command, $params);
            answerCallbackQuery($query['id'], "Help menu");
        }
        elseif ($data === 'test_notification') {
            // Test the auto-notification system
            if ($chat_id == ADMIN_ID) {
                $test_result = send_upload_notification(
                    "Test Movie (2024)",
                    "1080p",
                    "Hindi",
                    "9999"
                );
                
                if ($test_result) {
                    sendMessage($chat_id, "âœ… Test notification sent to request group!");
                    answerCallbackQuery($query['id'], "Test notification sent");
                } else {
                    sendMessage($chat_id, "âŒ Failed to send test notification");
                    answerCallbackQuery($query['id'], "Test failed", true);
                }
            } else {
                answerCallbackQuery($query['id'], "Admin only command!", true);
            }
        }
        else {
            sendMessage($chat_id, "âŒ Movie not found: " . $data);
            answerCallbackQuery($query['id'], "âŒ Movie not available");
        }
    }

    $current_hour = date('H');
    $current_minute = date('i');

    if ($current_hour == AUTO_BACKUP_HOUR && $current_minute == '00') {
        auto_backup();
        bot_log("Daily auto-backup completed");
    }

    if ($current_minute == '30') {
        global $movie_cache;
        $movie_cache = [];
        bot_log("Hourly cache cleanup");
    }
}

// ==============================
// STEP 31: TESTING SYSTEM
// ==============================
function send_test_notification($chat_id, $test_type = 'basic') {
    if ($chat_id != ADMIN_ID) {
        sendMessage($chat_id, "âŒ Access denied. Admin only command.");
        return;
    }
    
    $timestamp = date('Y-m-d H:i:s');
    $server_time = $timestamp;
    $server_timezone = date_default_timezone_get();
    
    // Create test message based on type
    $notification = "";
    
    switch ($test_type) {
        case 'notification':
            // Test auto-notification system
            $test_result = send_upload_notification(
                "Test Movie (2024)",
                "1080p",
                "Hindi",
                "9999"
            );
            
            if ($test_result) {
                $notification = "âœ… <b>Auto-Notification Test Successful</b>\n\n";
                $notification .= "ğŸ“… Test Time: $timestamp\n";
                $notification .= "ğŸ¬ Test Movie: Test Movie (2024)\n";
                $notification .= "ğŸ“Š Quality: 1080p\n";
                $notification .= "ğŸ—£ï¸ Language: Hindi\n\n";
                $notification .= "ğŸ“¡ <b>Sent to:</b> REQUEST_GROUP_ID (" . REQUEST_GROUP_ID . ")\n\n";
                $notification .= "âœ… <b>Status:</b> Notification delivered successfully!\n\n";
                $notification .= "ğŸ”” <b>Check your request group for the test message.</b>";
            } else {
                $notification = "âŒ <b>Auto-Notification Test Failed</b>\n\n";
                $notification .= "ğŸ“… Test Time: $timestamp\n\n";
                $notification .= "âš ï¸ <b>Possible Issues:</b>\n";
                $notification .= "1. Bot not added to request group\n";
                $notification .= "2. REQUEST_GROUP_ID incorrect\n";
                $notification .= "3. Bot lacks permission to send messages\n";
                $notification .= "4. Telegram API issues\n\n";
                $notification .= "ğŸ”§ <b>Check Environment Variables:</b>\n";
                $notification .= "â€¢ REQUEST_GROUP_ID: " . REQUEST_GROUP_ID . "\n";
                $notification .= "â€¢ CHANNEL_ID: " . CHANNEL_ID . "\n";
                $notification .= "â€¢ ADMIN_ID: " . ADMIN_ID;
            }
            break;
            
        case 'full':
            $system_status = check_system_status();
            $notification = "ğŸ”¬ <b>FULL SYSTEM DIAGNOSTICS</b>\n\n";
            $notification .= "ğŸ“± <b>Bot Information:</b>\n";
            $notification .= "â€¢ Bot Name: Entertainment Tadka\n";
            $notification .= "â€¢ Version: 2.1.0\n";
            $notification .= "â€¢ Admin ID: " . ADMIN_ID . "\n";
            $notification .= "â€¢ Server Time: $timestamp\n\n";
            
            $notification .= "ğŸ”— <b>Channel Configuration:</b>\n";
            $notification .= "â€¢ Main Channel: " . MAIN_CHANNEL . "\n";
            $notification .= "â€¢ Request Channel: " . REQUEST_CHANNEL . "\n";
            $notification .= "â€¢ Request Group: " . REQUEST_GROUP_ID . "\n";
            $notification .= "â€¢ Theater Print: " . THEATER_PRINT_CHANNEL . "\n";
            $notification .= "â€¢ Private Channel: " . CHANNEL_ID . "\n";
            $notification .= "â€¢ Backup Channel: " . BACKUP_CHANNEL_USERNAME . "\n\n";
            
            $notification .= "ğŸ“Š <b>System Health:</b>\n";
            $notification .= "â€¢ PHP Version: " . phpversion() . "\n";
            $notification .= "â€¢ Memory Usage: " . format_memory(memory_get_usage(true)) . "\n";
            $notification .= "â€¢ Disk Free: " . (disk_free_space(__DIR__) ? format_file_size(disk_free_space(__DIR__)) : 'Unknown') . "\n";
            $notification .= "â€¢ Bot Token: " . (defined('BOT_TOKEN') && BOT_TOKEN ? 'âœ… Valid' : 'âŒ Invalid') . "\n\n";
            
            $notification .= "âœ… <b>Auto-Notification System:</b> ACTIVE\n";
            $notification .= "â€¢ Movie uploads trigger notifications\n";
            $notification .= "â€¢ Request group: " . REQUEST_GROUP_ID . "\n";
            $notification .= "â€¢ Exact format as requested\n\n";
            
            $notification .= "ğŸ¯ <b>Test Summary:</b> All systems operational!";
            break;
            
        case 'channel':
            $notification = "ğŸ“¢ <b>CHANNEL CONNECTIVITY TEST</b>\n\n";
            $notification .= "ğŸ”— <b>Channel Status:</b>\n";
            $notification .= "â€¢ Main: " . MAIN_CHANNEL . " - âœ… Configured\n";
            $notification .= "â€¢ Requests: " . REQUEST_CHANNEL . " - âœ… Configured\n";
            $notification .= "â€¢ Request Group: " . REQUEST_GROUP_ID . " - âœ… Configured\n";
            $notification .= "â€¢ Theater Print: " . THEATER_PRINT_CHANNEL . " - âœ… Configured\n";
            $notification .= "â€¢ Backup: " . BACKUP_CHANNEL_USERNAME . " - âœ… Configured\n\n";
            
            $notification .= "ğŸš€ <b>Auto-Notification Ready:</b>\n";
            $notification .= "â€¢ Movies uploaded to " . CHANNEL_ID . "\n";
            $notification .= "â€¢ Notifications sent to " . REQUEST_GROUP_ID . "\n";
            $notification .= "â€¢ Exact format as requested\n\n";
            
            $notification .= "âœ… <b>All channels properly configured!</b>";
            break;
            
        default: // basic
            $stats = get_stats();
            $users_data = json_decode(file_get_contents(USERS_FILE), true);
            
            $notification = "ğŸ§ª <b>Basic System Test</b>\n\n";
            $notification .= "â° <b>Server Time:</b>\n";
            $notification .= "â€¢ Date/Time: $timestamp\n";
            $notification .= "â€¢ Timezone: $server_timezone\n\n";
            
            $notification .= "âœ… <b>System Status:</b>\n";
            $notification .= "â€¢ Bot: âœ… Online\n";
            $notification .= "â€¢ CSV File: " . (file_exists(CSV_FILE) ? 'âœ… OK' : 'âŒ Missing') . "\n";
            $notification .= "â€¢ Users File: " . (file_exists(USERS_FILE) ? 'âœ… OK' : 'âŒ Missing') . "\n";
            $notification .= "â€¢ Backup Dir: " . (file_exists(BACKUP_DIR) ? 'âœ… OK' : 'âŒ Missing') . "\n\n";
            
            $notification .= "ğŸ“Š <b>Quick Stats:</b>\n";
            $notification .= "â€¢ Movies: " . ($stats['total_movies'] ?? 0) . "\n";
            $notification .= "â€¢ Users: " . count($users_data['users'] ?? []) . "\n";
            $notification .= "â€¢ Searches: " . ($stats['total_searches'] ?? 0) . "\n\n";
            
            $notification .= "ğŸ”” <b>Auto-Notification System:</b>\n";
            $notification .= "â€¢ Status: âœ… ACTIVE\n";
            $notification .= "â€¢ Request Group: " . REQUEST_GROUP_ID . "\n";
            $notification .= "â€¢ Format: Exact as requested\n\n";
            
            $notification .= "ğŸ“ <b>Test Result:</b> PASSED âœ…";
            break;
    }
    
    // Send notification
    sendMessage($chat_id, $notification, null, 'HTML');
    bot_log("Test notification sent - Type: $test_type");
}

function check_system_status() {
    $status = [
        'bot_online' => true,
        'csv_exists' => file_exists(CSV_FILE),
        'users_exists' => file_exists(USERS_FILE),
        'backup_exists' => file_exists(BACKUP_DIR),
        'movie_count' => get_csv_count(),
        'user_count' => get_users_count(),
        'search_count' => get_stats()['total_searches'] ?? 0,
        'download_count' => get_stats()['total_downloads'] ?? 0,
        'pending_requests' => 0,
        'memory_usage' => format_memory(memory_get_usage(true)),
        'disk_free' => disk_free_space(__DIR__) ? format_file_size(disk_free_space(__DIR__)) : 'Unknown',
        'php_version' => phpversion(),
        'bot_token_valid' => defined('BOT_TOKEN') && BOT_TOKEN,
        'auto_notification_active' => defined('REQUEST_GROUP_ID') && REQUEST_GROUP_ID,
    ];
    
    return $status;
}

function format_file_size($bytes) {
    if ($bytes >= 1073741824) {
        return number_format($bytes / 1073741824, 2) . ' GB';
    } elseif ($bytes >= 1048576) {
        return number_format($bytes / 1048576, 2) . ' MB';
    } elseif ($bytes >= 1024) {
        return number_format($bytes / 1024, 2) . ' KB';
    } else {
        return $bytes . ' B';
    }
}

function format_memory($bytes) {
    $units = ['B', 'KB', 'MB', 'GB'];
    $index = 0;
    
    while ($bytes >= 1024 && $index < count($units) - 1) {
        $bytes /= 1024;
        $index++;
    }
    
    return round($bytes, 2) . ' ' . $units[$index];
}

// ==============================
// STEP 32: DEFAULT PAGE
// ==============================
if (!isset($update) || !$update) {
    $stats = get_stats();
    $users_data = json_decode(file_get_contents(USERS_FILE), true);
    
    echo "<h1>ğŸ¬ Entertainment Tadka Bot</h1>";
    echo "<p><strong>Version:</strong> 2.1.0 (With Auto-Notification)</p>";
    echo "<p><strong>Telegram Channel:</strong> " . MAIN_CHANNEL . "</p>";
    echo "<p><strong>Request Channel:</strong> " . REQUEST_CHANNEL . "</p>";
    echo "<p><strong>Theater Prints:</strong> " . THEATER_PRINT_CHANNEL . "</p>";
    echo "<p><strong>Backup Channel:</strong> " . BACKUP_CHANNEL_USERNAME . "</p>";
    echo "<p><strong>Status:</strong> âœ… Running</p>";
    echo "<p><strong>Total Movies:</strong> " . ($stats['total_movies'] ?? 0) . "</p>";
    echo "<p><strong>Total Users:</strong> " . count($users_data['users'] ?? []) . "</p>";
    echo "<p><strong>Total Searches:</strong> " . ($stats['total_searches'] ?? 0) . "</p>";
    echo "<p><strong>Last Updated:</strong> " . ($stats['last_updated'] ?? 'N/A') . "</p>";
    
    echo "<h3>ğŸš€ New Features</h3>";
    echo "<ul>";
    echo "<li>âœ… Auto-Notification to Request Group</li>";
    echo "<li>âœ… Exact notification format as requested</li>";
    echo "<li>âœ… Theater Print Channel integration</li>";
    echo "<li>âœ… Enhanced movie delivery system</li>";
    echo "<li>âœ… Complete user management</li>";
    echo "<li>âœ… Points system & leaderboard</li>";
    echo "<li>âœ… Advanced pagination</li>";
    echo "<li>âœ… Auto-backup system</li>";
    echo "</ul>";
    
    echo "<h3>ğŸ”” Auto-Notification System</h3>";
    echo "<p><strong>How it works:</strong></p>";
    echo "<ol>";
    echo "<li>Movie uploaded to channel (" . CHANNEL_ID . ")</li>";
    echo "<li>Bot automatically captures movie details</li>";
    echo "<li>Bot sends notification to request group (" . REQUEST_GROUP_ID . ")</li>";
    echo "<li>Notification uses exact requested format</li>";
    echo "<li>Users can search movies immediately</li>";
    echo "</ol>";
    
    echo "<h3>ğŸ“± Notification Preview</h3>";
    echo "<pre>";
    echo "ğŸ¬ NEW UPLOAD ALERT!\n\n";
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    echo "âœ… Movie / Webseries Add Ho Gayi Hai: \n\n";
    echo "â€¢ Name: Test Movie\n\n";
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    echo "ğŸ“¥ Abhi Available Hai: â€¢ Bot se search karo: Test Movie\n\n";
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    echo "ğŸ¯ Bot Use Karne Ka Tarika: \n";
    echo "â€¢ Search ke liye: /search Test Movie\n\n";
    echo "â€¢ Sab uploads dekhne ke liye: /totalupload (Sirf Admin Ke liye)\n\n";
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    echo "ğŸ“¢ Join Our Channels:\n\n";
    echo "ğŸ¿ Main: @EntertainmentTadka786\n  \n";
    echo "ğŸ“¥ Requests: @EntertainmentTadka7860\n\n";
    echo "ğŸ­ Theater Print Channel: @threater_print_movies\n\n";
    echo "ğŸ”’ Backup: @ETBackup\n\n";
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
    echo "ğŸ”” Aur movies/webseries ke liye request karte raho! ğŸ”¥";
    echo "</pre>";
    
    echo "<h3>ğŸš€ Quick Setup</h3>";
    echo "<p><a href='?setwebhook=1'>Set Webhook Now</a></p>";
    echo "<p><a href='?test_notification=1'>Test Auto-Notification</a></p>";
    echo "<p><a href='?test_save=1'>Test Movie Save</a></p>";
    echo "<p><a href='?check_csv=1'>Check CSV Data</a></p>";
    
    echo "<h3>ğŸ“‹ Available Commands</h3>";
    echo "<ul>";
    echo "<li><code>/start</code> - Welcome message</li>";
    echo "<li><code>/help</code> - All commands</li>";
    echo "<li><code>/search movie</code> - Search movies</li>";
    echo "<li><code>/browse</code> - Enhanced pagination</li>";
    echo "<li><code>/request movie</code> - Request movie</li>";
    echo "<li><code>/mystats</code> - User statistics</li>";
    echo "<li><code>/leaderboard</code> - Top users</li>";
    echo "<li><code>/channel</code> - Join channels</li>";
    echo "<li><code>/stats</code> - Admin statistics</li>";
    echo "<li><code>/test notification</code> - Test auto-notification</li>";
    echo "</ul>";
    
    if (file_exists(LOG_FILE)) {
        $logs = array_slice(file(LOG_FILE), -10);
        echo "<h3>ğŸ“Š Recent Activity</h3>";
        echo "<pre>";
        foreach ($logs as $log) {
            echo htmlspecialchars($log);
        }
        echo "</pre>";
    }
}

// ==============================
// STEP 33: TESTING FUNCTIONS
// ==============================
if (isset($_GET['test_save'])) {
    function manual_save_to_csv($movie_name, $message_id, $quality = '1080p', $language = 'Hindi') {
        $entry = [$movie_name, $message_id, date('d-m-Y'), '', $quality, '1.5GB', $language];
        $handle = fopen(CSV_FILE, "a");
        if ($handle !== FALSE) {
            fputcsv($handle, $entry);
            fclose($handle);
            @chmod(CSV_FILE, 0666);
            return true;
        }
        return false;
    }
    
    manual_save_to_csv("Metro In Dino (2025)", 1924, "1080p", "Hindi");
    manual_save_to_csv("Metro In Dino 2025 WebRip 480p", 1925, "480p", "Hindi");
    manual_save_to_csv("Metro In Dino (2025) Hindi 720p", 1926, "720p", "Hindi");
    manual_save_to_csv("Animal (2023) Hindi 1080p", 1927, "1080p", "Hindi");
    manual_save_to_csv("Avengers Endgame (2019) English", 1928, "1080p", "English");
    
    echo "âœ… All 5 movies manually save ho gayi!<br>";
    echo "ğŸ“Š <a href='?check_csv=1'>Check CSV</a> | ";
    echo "<a href='?setwebhook=1'>Reset Webhook</a> | ";
    echo "<a href='?test_stats=1'>Test Stats</a>";
    exit;
}

if (isset($_GET['check_csv'])) {
    echo "<h3>CSV Content:</h3>";
    if (file_exists(CSV_FILE)) {
        $lines = file(CSV_FILE);
        foreach ($lines as $line) {
            echo htmlspecialchars($line) . "<br>";
        }
    } else {
        echo "âŒ CSV file not found!";
    }
    exit;
}

if (isset($_GET['setwebhook'])) {
    $webhook_url = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
    $result = apiRequest('setWebhook', ['url' => $webhook_url]);
    
    echo "<h1>Webhook Setup</h1>";
    echo "<p>Result: " . htmlspecialchars($result) . "</p>";
    echo "<p>Webhook URL: " . htmlspecialchars($webhook_url) . "</p>";
    
    $bot_info = json_decode(apiRequest('getMe'), true);
    if ($bot_info && isset($bot_info['ok']) && $bot_info['ok']) {
        echo "<h2>Bot Info</h2>";
        echo "<p>Name: " . htmlspecialchars($bot_info['result']['first_name']) . "</p>";
        echo "<p>Username: @" . htmlspecialchars($bot_info['result']['username']) . "</p>";
        echo "<p>Channel: " . MAIN_CHANNEL . "</p>";
        echo "<p>Request Channel: " . REQUEST_CHANNEL . "</p>";
        echo "<p>Theater Print: " . THEATER_PRINT_CHANNEL . "</p>";
        echo "<p>Backup Channel: " . BACKUP_CHANNEL_USERNAME . "</p>";
    }
    
    echo "<h3>System Status</h3>";
    echo "<p>CSV File: " . (file_exists(CSV_FILE) ? "âœ… Exists" : "âŒ Missing") . "</p>";
    echo "<p>Users File: " . (file_exists(USERS_FILE) ? "âœ… Exists" : "âŒ Missing") . "</p>";
    echo "<p>Stats File: " . (file_exists(STATS_FILE) ? "âœ… Exists" : "âŒ Missing") . "</p>";
    echo "<p>Backup Directory: " . (file_exists(BACKUP_DIR) ? "âœ… Exists" : "âŒ Missing") . "</p>";
    
    echo "<h3>Auto-Notification Configuration</h3>";
    echo "<p>Request Group ID: " . REQUEST_GROUP_ID . "</p>";
    echo "<p>Private Channel ID: " . CHANNEL_ID . "</p>";
    echo "<p>Admin ID: " . ADMIN_ID . "</p>";
    
    exit;
}

if (isset($_GET['test_notification'])) {
    // Test auto-notification system
    $test_result = send_upload_notification(
        "Test Movie (2024)",
        "1080p",
        "Hindi",
        "9999"
    );
    
    if ($test_result) {
        echo "<h2>âœ… Test Notification Sent!</h2>";
        echo "<p>Check your request group for the test notification.</p>";
        echo "<p>Format exactly as requested:</p>";
        echo "<pre>";
        echo "ğŸ¬ NEW UPLOAD ALERT!\n\n";
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
        echo "âœ… Movie / Webseries Add Ho Gayi Hai: \n\n";
        echo "â€¢ Name: Test Movie (2024)\n\n";
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
        echo "ğŸ“¥ Abhi Available Hai: â€¢ Bot se search karo: Test Movie (2024)\n\n";
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
        echo "ğŸ¯ Bot Use Karne Ka Tarika: \n";
        echo "â€¢ Search ke liye: /search Test Movie (2024)\n\n";
        echo "â€¢ Sab uploads dekhne ke liye: /totalupload (Sirf Admin Ke liye)\n\n";
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
        echo "ğŸ“¢ Join Our Channels:\n\n";
        echo "ğŸ¿ Main: " . MAIN_CHANNEL . "\n  \n";
        echo "ğŸ“¥ Requests: " . REQUEST_CHANNEL . "\n\n";
        echo "ğŸ­ Theater Print Channel: " . THEATER_PRINT_CHANNEL . "\n\n";
        echo "ğŸ”’ Backup: " . BACKUP_CHANNEL_USERNAME . "\n\n";
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
        echo "ğŸ”” Aur movies/webseries ke liye request karte raho! ğŸ”¥";
        echo "</pre>";
    } else {
        echo "<h2>âŒ Test Failed</h2>";
        echo "<p>Could not send test notification.</p>";
        echo "<p>Make sure:</p>";
        echo "<ol>";
        echo "<li>Bot is added to request group</li>";
        echo "<li>REQUEST_GROUP_ID is correct in environment variables</li>";
        echo "<li>Bot has permission to send messages in group</li>";
        echo "</ol>";
    }
    
    echo "<p><a href='?'>Back to main page</a></p>";
    exit;
}
?>